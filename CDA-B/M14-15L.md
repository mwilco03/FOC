
## üîê **Kerberos Pre-Authentication & Ticket Components**

### üîé Pre-Authentication Overview

* **Purpose**: Prevent password-guessing/replay attacks by requiring timestamp encrypted with user‚Äôs password hash before AS\_REP is issued.
* **Audit Relevance**: Logs failed attempts, aids in identifying enumeration attempts.

### üìå PowerShell for Verification

```powershell
Get-ADUser -Filter * -Properties "DoesNotRequirePreAuth" | 
Where-Object { $_.DoesNotRequirePreAuth -eq $true } | 
Select-Object Name, SamAccountName
```

* **What this does**: Identifies accounts that do **not** require Kerberos pre-authentication, potentially vulnerable.

---

## üóùÔ∏è **Identifying Session Keys & Ticket Granting Ticket (TGT) Keys**

### üîß Using Wireshark (GUI tool)

* Open `.pcapng` file capturing AS-REQ / AS-REP
* Locate:

  * **Session Key** ‚Üí Found in AS\_REP (encrypted with user‚Äôs key)
  * **TGT Encrypted Part** ‚Üí Contains session key + timestamp

### üß™ Command (Mimikatz)

```mimikatz
kerberos::list
```

* Lists current Kerberos tickets in memory (useful to see encryption types and lifespan)

### üìå Optional PowerShell Inspection

```powershell
klist
```

* **Purpose**: Displays active Kerberos tickets and their expiration times

---

## üîç **Active Directory Enumeration & Security Configuration Checks**

### üßë‚Äçü§ù‚Äçüßë User Enumeration & Password Audits

```powershell
Get-ADUser -Filter * -Properties * | Select Name, PasswordLastSet, Enabled, LastLogonDate
```

```powershell
Get-ADUser jdoe -Properties * | Format-List
```

### üõ°Ô∏è Group Membership and Privilege Inspection

```powershell
Get-ADGroup -Filter *
Get-ADGroupMember -Identity "Domain Admins"
```

```powershell
Get-ADGroupMember -Identity "Domain Admins" |
Select-Object name, objectClass, distinguishedName |
Export-Csv -Path ‚ÄúDomainAdminGroupMembers.csv‚Äù
```

---

## üß∞ **Tools & GUI Operations**

### ‚úÖ ADUC (Active Directory Users & Computers)

* **Navigate**: View ‚Üí Advanced Features
* **Verify**:

  * `Logon Hours`
  * Group Membership
  * Security / Distribution Groups
  * Account ‚Üí "Do not require Kerberos preauthentication" checkbox

---

## ü™™ **Auditing Policies for Kerberos & DCSync Detection**

### üîé Auditing Directory Services

```powershell
auditpol /set /subcategory:"Directory Service Changes" /success:enable /failure:enable
```

```powershell
auditpol /get /category:*
```

### üß† Audit Policy: DCSync

* **Event ID**: `4662` ‚Äî Object access (with `replicating directory changes`)
* **Command**:

```powershell
(Get-Acl "AD:\CN=Configuration,DC=yourdomain,DC=com").Access |
Where-Object { $_.ActiveDirectoryRights -like "*Replicating*" }
```

---

## üõ†Ô∏è **Credential Dumping & Mimikatz**

### üß™ Commands

```mimikatz
lsadump::dcsync /domain:yourdomain.local /user:krbtgt
kerberos::golden /domain:yourdomain.local /sid:S-1-5-21-xxx /krbtgt:NTLMHASH /user:Administrator /id:500 /ptt
```

---

## üîÑ **Group Policy & Enforcement Verification**

### üîÅ Refresh GPOs

```powershell
gpupdate /force
Invoke-GPUpdate -Force
```

### üìã View Resultant Policies

```powershell
gpresult /SCOPE COMPUTER /V
rsop.msc
```

### üîê Confirm NTLMv2 Settings

```powershell
Get-GPO -All | Where-Object { $_.DisplayName -like "*NTLMv2*" }
```

---

## üîí **Hardening NTLM and LM Configurations**

### üîß Registry (PtH Mitigation)

```powershell
Set-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System" -Name LocalAccountTokenFilterPolicy -Value 0 -Type DWord
```

### üìú GPO Policies to Set

* **Password Complexity**: Enabled
* **Min Length**: 14+
* **LAN Manager Authentication Level**:

  * Set: ‚ÄúSend NTLMv2 response only. Refuse LM & NTLM‚Äù
* **Do not store LM hashes**: Enabled
* **Encryption types for Kerberos**: AES128 & AES256 only

---

## üîç **Detection via Event Viewer and Sysmon**

| Purpose                        | Tool/Path    | Event ID   |
| ------------------------------ | ------------ | ---------- |
| Logon (Success/Fail)           | Event Viewer | 4624, 4634 |
| Elevated Privilege Use         | Event Viewer | 4672       |
| Ticket Granting Service        | Event Viewer | 4769       |
| Directory Replication (DCSync) | Event Viewer | 4662       |
| Memory Access to LSASS         | Sysmon       | 10         |

---

## üîÅ **Resetting KRBTGT to Invalidate Golden Tickets**

### üõ†Ô∏è GUI Steps

* Open ADUC ‚Üí Users ‚Üí krbtgt ‚Üí Reset password **twice**

---

## üìÅ **LDAP & RSAT Validation**

### üîç RSAT Check

```powershell
Get-WindowsFeature -Name RSAT-AD-Tools
```

### üß© Use LDP.exe to:

* Bind to AD
* Explore schema
* Validate replication topology

---

## üìä **SIEM / Log Analysis for Kerberos Abuse**

### üîç Sample Queries (Elastic/Kibana)

```siem
event.code:4769 AND winlog.event_data.Status:"0x1F"
event.code:4688 AND user.name:"Administrator" AND winlog.event_data.CommandLine:"net *"
event.code:(4720 OR 4722 OR 4724 OR 4738)
```

---

## üèÅ Summary of Defense Measures

| Defense Area               | PowerShell / GPO / Tool            |
| -------------------------- | ---------------------------------- |
| Enforce AES encryption     | GPO + `Configure encryption types` |
| Detect forged tickets      | Event ID 4769, 4662, 4624          |
| Prevent LM/NTLM            | GPO ‚Üí "LAN Manager Auth Level"     |
| Invalidate golden tickets  | Reset `krbtgt` twice               |
| Monitor credential theft   | Sysmon Event ID 10                 |
| Enforce Pre-authentication | ADUC: Uncheck "Do not require..."  |
| Logon/logoff auditing      | `auditpol` + Event Viewer          |

---

# üîê **Kerberos, Pre-Authentication, and Ticket Discovery via PowerShell**

---

## üßæ **1. Identify Session Key & TGT Key (Encrypted Parts)**

While PowerShell cannot directly decrypt Kerberos packets, it can validate tickets in memory.

### üõ†Ô∏è Ticket Inspection

```powershell
klist
```

> Shows current Kerberos TGTs and TGS tickets in the session.

---

## üõ°Ô∏è **2. Pre-Authentication Detection**

### üîç Identify Accounts with Pre-Authentication Disabled

```powershell
Get-ADUser -Filter * -Properties DoesNotRequirePreAuth |
Where-Object { $_.DoesNotRequirePreAuth -eq $true } |
Select-Object Name, SamAccountName
```

> Lists accounts vulnerable to AS-REP Roasting.

---

# üß∞ **3. Audit Policy Configuration & Kerberos Logging**

### üîé View Current Audit Settings

```powershell
auditpol /get /category:*
```

### üõ†Ô∏è Enable Audit for Directory Service Changes (for DCSync detection)

```powershell
auditpol /set /subcategory:"Directory Service Changes" /success:enable /failure:enable
```

### üõ†Ô∏è Enable Logon Auditing

```powershell
auditpol /set /subcategory:"Logon" /success:enable /failure:enable
```

---

# üßë‚Äçüíª **4. Active Directory Recon and User Analysis**

### üîç List All Domain Users

```powershell
Get-ADUser -Filter * | Select-Object SamAccountName
```

### üìã Get Full User Object Details

```powershell
Get-ADUser jdoe -Properties * | Format-List
```

### üì§ Export User Attributes to CSV

```powershell
Get-ADUser leonard.blevins -Properties * | Export-Csv -Path .\leonard.blevins.csv -NoTypeInformation
```

### üîç View All Groups

```powershell
Get-ADGroup -Filter * | Select-Object Name, GroupScope, GroupCategory
```

### üîç Get Members of Key Groups (e.g., Domain Admins)

```powershell
Get-ADGroupMember -Identity "Domain Admins" |
Select-Object Name, ObjectClass, DistinguishedName
```

---

# üîê **5. Privileged Group Membership Audit**

### üì§ Export Domain Admin Members to CSV

```powershell
Get-ADGroupMember -Identity "Domain Admins" |
Select-Object Name, ObjectClass, DistinguishedName |
Export-Csv -Path .\DomainAdmins.csv -NoTypeInformation
```

---

# üí£ **6. DCSync Attack Simulation (Mimikatz required)**

```plaintext
lsadump::dcsync /domain:yourdomain.local /user:krbtgt
```

> Run in Mimikatz to simulate DCSync. PowerShell can‚Äôt do this natively but **monitor** for it via:

```powershell
Get-WinEvent -FilterHashtable @{LogName='Security'; Id=4662}
```

---

# üîÅ **7. Group Policy Enforcement & Policy Inspection**

### üîÅ Force Group Policy Refresh

```powershell
gpupdate /force
Invoke-GPUpdate -Force
```

### üìã View GPO Result Summary

```powershell
gpresult /SCOPE COMPUTER /V
```

### üîç List All GPOs and Check NTLM Policy

```powershell
Get-GPO -All | Where-Object { $_.DisplayName -like "*NTLM*" }
```

---

# üîê **8. NTLM & LM Protocol Hardening via GPO/Registry**

### üîé Verify NTLM Settings (Registry-based enforcement)

```powershell
Get-ItemProperty "HKLM:\SYSTEM\CurrentControlSet\Control\Lsa" | Select LmCompatibilityLevel
```

### üõ†Ô∏è Set to "Send NTLMv2 only. Refuse LM & NTLM"

```powershell
Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Lsa" -Name LmCompatibilityLevel -Value 5
```

---

# üîê **9. Golden/Silver Ticket Mitigations**

### üîÅ Reset krbtgt (Manual via GUI recommended but log status via PowerShell)

```powershell
Get-ADUser krbtgt -Properties PasswordLastSet | Select-Object SamAccountName, PasswordLastSet
```

> Reset this account‚Äôs password **twice** in ADUC GUI.

---

# üîé **10. Kerberos Ticket Policy Validation**

### üìã Check Kerberos Ticket Lifetime Settings

```powershell
Get-ADDefaultDomainPasswordPolicy
```

### üîç Configure Allowed Kerberos Encryption Types (via registry or GPO):

> No native PowerShell for this ‚Äî enforced via GPO:

* AES128 & AES256: ‚úÖ
* RC4, DES: ‚ùå

---

# üß© **11. RSAT & LDAP Validation**

### üß∞ Check RSAT Installation

```powershell
Get-WindowsFeature RSAT-AD-PowerShell
```

### üîç Browse AD via PowerShell

```powershell
Get-ADObject -Filter * -SearchBase "DC=yourdomain,DC=local" -SearchScope Subtree
```

---

# üõë **12. Local Account Token Filtering (PtH Mitigation)**

### üõ†Ô∏è Enforce Remote Token Filter Policy

```powershell
Set-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System" -Name LocalAccountTokenFilterPolicy -Value 0 -Type DWord
```

---

# üß† **13. Whoami & Contextual Execution Checks**

### üÜî Check Current User Session

```powershell
whoami
```

---

# ‚úÖ Summary Table

| **Use Case**                        | **PowerShell Command**                                              |                  |
| ----------------------------------- | ------------------------------------------------------------------- | ---------------- |
| List domain users                   | `Get-ADUser -Filter *`                                              |                  |
| Identify pre-auth disabled accounts | `Get-ADUser -Filter * -Properties DoesNotRequirePreAuth`            |                  |
| View audit policy                   | `auditpol /get /category:*`                                         |                  |
| Enable DS auditing                  | `auditpol /set /subcategory:"Directory Service Changes" ...`        |                  |
| Export domain admins                | \`Get-ADGroupMember -Identity "Domain Admins"                       |                  |
| Force GP update                     | `gpupdate /force`                                                   |                  |
| List Kerberos tickets               | `klist`                                                             |                  |
| Set NTLMv2 only                     | `Set-ItemProperty -Path ... LmCompatibilityLevel -Value 5`          |                  |
| Enforce token filtering             | `Set-ItemProperty -Path ... LocalAccountTokenFilterPolicy -Value 0` |                  |
| Validate krbtgt password change     | `Get-ADUser krbtgt -Properties PasswordLastSet`                     |                  |


