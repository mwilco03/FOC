<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Subnet Quest - NetDrill</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
:root {
  --bg-primary: #0a0e17;
  --bg-secondary: #111827;
  --bg-card: #1a2235;
  --border: #2a3650;
  --text-primary: #e2e8f0;
  --text-secondary: #94a3b8;
  --text-muted: #64748b;
  --accent-blue: #3b82f6;
  --accent-cyan: #06b6d4;
  --accent-green: #10b981;
  --accent-amber: #f59e0b;
  --accent-red: #ef4444;
  --accent-purple: #8b5cf6;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: 'JetBrains Mono', monospace;
  background: var(--bg-primary);
  color: var(--text-primary);
  min-height: 100vh;
}
body::before {
  content: '';position: fixed;inset: 0;
  background: linear-gradient(rgba(59,130,246,0.03) 1px, transparent 1px),linear-gradient(90deg, rgba(59,130,246,0.03) 1px, transparent 1px);
  background-size: 60px 60px;pointer-events: none;
}
.container {
  position: relative;z-index: 1;max-width: 750px;margin: 0 auto;padding: 1rem;
}
.top-bar {
  display: flex;justify-content: space-between;align-items: center;
  padding: 0.5rem 0;border-bottom: 1px solid var(--border);margin-bottom: 1rem;
}
.top-bar a { color: var(--text-muted); text-decoration: none; font-size: 0.75rem; }
.top-bar a:hover { color: var(--accent-cyan); }
.top-bar h1 {
  font-family: 'Press Start 2P', monospace;font-size: 0.85rem;
  background: linear-gradient(135deg, var(--accent-purple), var(--accent-pink, #ec4899));
  -webkit-background-clip: text;-webkit-text-fill-color: transparent;
}
.player-stats {
  display: flex;gap: 1rem;font-size: 0.7rem;color: var(--text-muted);
  padding: 0.5rem 0;flex-wrap: wrap;
}
.player-stats .pv { color: var(--accent-cyan); font-weight: 700; }

/* World map */
.world-map {
  display: grid;grid-template-columns: repeat(3, 1fr);gap: 0.75rem;margin-bottom: 1rem;
}
.zone-card {
  background: var(--bg-card);border: 2px solid var(--border);border-radius: 8px;
  padding: 0.8rem;text-align: center;cursor: pointer;transition: all 0.2s;position: relative;
}
.zone-card:hover:not(.locked) { border-color: var(--accent-blue); transform: translateY(-2px); }
.zone-card.locked { opacity: 0.4; cursor: not-allowed; }
.zone-card.cleared { border-color: var(--accent-green); }
.zone-card.cleared::after {
  content: '\2713';position: absolute;top: 4px;right: 8px;color: var(--accent-green);
  font-size: 0.8rem;font-weight: 700;
}
.zone-card.active { border-color: var(--accent-amber); box-shadow: 0 0 15px rgba(245,158,11,0.2); }
.zone-card .zone-num {
  font-family: 'Press Start 2P', monospace;font-size: 0.55rem;color: var(--text-muted);
}
.zone-card .zone-name {
  font-family: 'Press Start 2P', monospace;font-size: 0.55rem;color: var(--text-primary);margin-top: 0.3rem;
}
.zone-card .zone-icon { font-size: 1.5rem; margin-bottom: 0.3rem; }

/* Battle scene */
.battle-scene { display: none; }
.battle-scene.active { display: block; animation: fadeIn 0.3s; }
@keyframes fadeIn { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }

.battle-field {
  background: var(--bg-secondary);border: 1px solid var(--border);border-radius: 12px;
  padding: 1.5rem;min-height: 240px;display: flex;justify-content: space-between;
  align-items: flex-end;position: relative;overflow: hidden;
}

/* Pixel sprites via CSS */
.sprite-container {
  text-align: center;width: 120px;
}
.sprite-container .sprite-name {
  font-family: 'Press Start 2P', monospace;font-size: 0.5rem;color: var(--text-muted);margin-bottom: 0.4rem;
}
.pixel-sprite {
  width: 64px;height: 64px;margin: 0 auto 0.5rem;
  image-rendering: pixelated;position: relative;
}
.hp-bar-bg {
  width: 100%;height: 8px;background: #1a1a2e;border-radius: 4px;overflow: hidden;
  border: 1px solid var(--border);
}
.hp-bar {
  height: 100%;border-radius: 4px;transition: width 0.5s ease;
}
.hp-bar.player { background: var(--accent-green); }
.hp-bar.enemy { background: var(--accent-red); }
.hp-text {
  font-size: 0.6rem;color: var(--text-muted);margin-top: 2px;text-align: center;
}

/* Damage numbers */
.damage-num {
  position: absolute;font-family: 'Press Start 2P', monospace;font-size: 0.8rem;
  pointer-events: none;animation: damageFloat 1s ease-out forwards;z-index: 10;
}
@keyframes damageFloat {
  0% { opacity: 1; transform: translateY(0); }
  100% { opacity: 0; transform: translateY(-40px); }
}

/* Battle VS display */
.battle-vs {
  font-family: 'Press Start 2P', monospace;font-size: 0.7rem;color: var(--accent-amber);
  align-self: center;
}

/* Flash effects */
.flash-red { animation: flashRed 0.3s; }
@keyframes flashRed { 0%,100%{filter:none} 50%{filter:brightness(2) sepia(1) hue-rotate(-50deg)} }
.flash-green { animation: flashGreen 0.3s; }
@keyframes flashGreen { 0%,100%{filter:none} 50%{filter:brightness(2) sepia(1) hue-rotate(80deg)} }
.shake { animation: shake 0.4s; }
@keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-6px)} 75%{transform:translateX(6px)} }

/* Question in battle */
.battle-question {
  background: var(--bg-card);border: 1px solid var(--border);border-radius: 8px;
  padding: 1rem;margin-top: 1rem;
}
.battle-question .bq-text {
  font-family: 'Press Start 2P', monospace;font-size: 0.6rem;line-height: 1.8;
  color: var(--text-primary);margin-bottom: 0.75rem;text-align: center;
}
.battle-options {
  display: flex;flex-wrap: wrap;gap: 0.5rem;justify-content: center;
}
.battle-opt {
  font-family: 'JetBrains Mono', monospace;font-size: 0.78rem;
  padding: 0.5rem 1rem;background: var(--bg-secondary);border: 2px solid var(--border);
  border-radius: 8px;color: var(--text-primary);cursor: pointer;transition: all 0.15s;
  min-width: 70px;text-align: center;
}
.battle-opt:hover:not(.disabled) { border-color: var(--accent-blue); }
.battle-opt.correct { border-color: var(--accent-green); background: rgba(16,185,129,0.15); color: var(--accent-green); }
.battle-opt.wrong { border-color: var(--accent-red); background: rgba(239,68,68,0.15); color: var(--accent-red); }
.battle-opt.disabled { pointer-events: none; opacity: 0.5; }

/* Bit-position reference for binary questions */
.bit-ref {
  display: inline-block;
  font-family: 'JetBrains Mono', monospace;
  margin: 0.4rem auto 0.2rem;
  padding: 0.4rem 0.6rem;
  background: rgba(6,182,212,0.08);
  border: 1px solid rgba(6,182,212,0.2);
  border-radius: 6px;
}
.bit-ref .bit-positions {
  display: flex; justify-content: center; gap: 0;
  font-size: 0.55rem; color: var(--accent-cyan); letter-spacing: 0;
}
.bit-ref .bit-digits {
  display: flex; justify-content: center; gap: 0;
  font-size: 0.75rem; color: var(--text-primary); margin-top: 2px;
}
.bit-ref .bit-positions span,
.bit-ref .bit-digits span {
  width: 2ch; text-align: center;
}
.bit-ref .bit-digits span.one { color: var(--accent-green); font-weight: 700; }
.bit-ref .bit-digits span.zero { color: var(--text-muted); }

/* Boss fight fill-in */
.boss-fields {
  display: grid;grid-template-columns: 1fr 1fr;gap: 0.5rem;margin-top: 0.75rem;
}
.boss-field {
  display: flex;align-items: center;gap: 0.5rem;
}
.boss-field label {
  font-size: 0.65rem;color: var(--text-muted);width: 80px;flex-shrink: 0;
}
.boss-field input {
  flex: 1;padding: 0.4rem;font-family: 'JetBrains Mono', monospace;font-size: 0.78rem;
  background: var(--bg-secondary);border: 1px solid var(--border);border-radius: 4px;
  color: var(--text-primary);outline: none;
}
.boss-field input:focus { border-color: var(--accent-blue); }
.boss-field input.correct-input { border-color: var(--accent-green); background: rgba(16,185,129,0.08); }
.boss-field input.incorrect-input { border-color: var(--accent-red); background: rgba(239,68,68,0.08); }

.battle-log {
  font-size: 0.65rem;color: var(--text-muted);text-align: center;
  margin-top: 0.5rem;min-height: 1.2em;
}

.btn-action {
  font-family: 'Press Start 2P', monospace;font-size: 0.6rem;
  padding: 0.6rem 1.5rem;background: var(--accent-blue);border: none;
  border-radius: 6px;color: #fff;cursor: pointer;transition: all 0.2s;
}
.btn-action:hover { background: #2563eb; }
.btn-action.green { background: var(--accent-green); }
.btn-action.green:hover { background: #059669; }

@media (max-width: 600px) {
  .world-map { grid-template-columns: repeat(2, 1fr); }
  .battle-field { padding: 1rem; min-height: 200px; }
  .pixel-sprite { width: 48px; height: 48px; }
  .boss-fields { grid-template-columns: 1fr; }
}
</style>
</head>
<body>
<div class="container">
  <div class="top-bar">
    <a href="../index.html">&larr; Back</a>
    <h1>SUBNET QUEST</h1>
    <span style="font-size:0.6rem;color:var(--text-muted);">RPG</span>
  </div>
  <div class="player-stats">
    <div>LVL: <span class="pv" id="playerLvl">1</span></div>
    <div>XP: <span class="pv" id="playerXp">0</span></div>
    <div>HP: <span class="pv" id="playerHpStat">100</span></div>
    <div>ZONES: <span class="pv" id="zonesCleared">0</span>/6</div>
  </div>

  <!-- World Map -->
  <div id="worldMap" class="world-map"></div>

  <!-- Battle Scene -->
  <div id="battleScene" class="battle-scene">
    <div class="battle-field" id="battleField">
      <div class="sprite-container" id="playerSprite">
        <div class="sprite-name" id="playerName">HERO</div>
        <canvas class="pixel-sprite" id="heroCanvas" width="64" height="64"></canvas>
        <div class="hp-bar-bg"><div class="hp-bar player" id="playerHpBar" style="width:100%"></div></div>
        <div class="hp-text" id="playerHpText">100/100</div>
      </div>
      <div class="battle-vs">VS</div>
      <div class="sprite-container" id="enemySprite">
        <div class="sprite-name" id="enemyName">GOBLIN</div>
        <canvas class="pixel-sprite" id="enemyCanvas" width="64" height="64"></canvas>
        <div class="hp-bar-bg"><div class="hp-bar enemy" id="enemyHpBar" style="width:100%"></div></div>
        <div class="hp-text" id="enemyHpText">50/50</div>
      </div>
    </div>
    <div class="battle-question" id="battleQuestion"></div>
    <div class="battle-log" id="battleLog"></div>
  </div>
</div>

<script>
// =====================================================================
// PIXEL SPRITE DRAWING
// =====================================================================
function drawPixelArt(canvas, pattern, palette) {
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, 64, 64);
  const s = 64 / pattern.length;
  pattern.forEach((row, y) => {
    for (let x = 0; x < row.length; x++) {
      const c = row[x];
      if (c !== 0 && palette[c]) {
        ctx.fillStyle = palette[c];
        ctx.fillRect(x * s, y * s, s + 0.5, s + 0.5);
      }
    }
  });
}

const HERO_PATTERN = [
  [0,0,0,0,1,1,0,0,0,0],
  [0,0,0,1,1,1,1,0,0,0],
  [0,0,0,2,2,2,2,0,0,0],
  [0,0,2,2,3,3,2,2,0,0],
  [0,0,2,3,4,4,3,2,0,0],
  [0,0,0,2,2,2,2,0,0,0],
  [0,0,5,5,5,5,5,5,0,0],
  [0,5,5,6,5,5,6,5,5,0],
  [0,5,5,5,5,5,5,5,5,0],
  [0,0,5,5,5,5,5,5,0,0],
  [0,0,0,5,0,0,5,0,0,0],
  [0,0,0,7,0,0,7,0,0,0],
];
const HERO_PALETTE = {0:null,1:'#f59e0b',2:'#fbbf24',3:'#fde68a',4:'#1e3a5f',5:'#3b82f6',6:'#60a5fa',7:'#6b7280'};

const ENEMY_SPRITES = {
  goblin: {
    pattern: [
      [0,0,0,1,1,1,0,0,0,0],
      [0,0,1,2,2,2,1,0,0,0],
      [0,1,2,3,2,3,2,1,0,0],
      [0,1,2,2,4,2,2,1,0,0],
      [0,0,1,2,2,2,1,0,0,0],
      [0,0,0,5,5,5,0,0,0,0],
      [0,0,5,5,5,5,5,0,0,0],
      [0,5,5,5,5,5,5,5,0,0],
      [0,5,0,5,5,5,0,5,0,0],
      [0,0,0,6,0,6,0,0,0,0],
    ],
    palette: {0:null,1:'#065f46',2:'#10b981',3:'#ef4444',4:'#064e3b',5:'#92400e',6:'#78716c'}
  },
  skeleton: {
    pattern: [
      [0,0,0,1,1,1,0,0,0,0],
      [0,0,1,1,1,1,1,0,0,0],
      [0,0,1,2,1,2,1,0,0,0],
      [0,0,1,1,3,1,1,0,0,0],
      [0,0,0,1,1,1,0,0,0,0],
      [0,0,0,4,4,4,0,0,0,0],
      [0,0,4,4,4,4,4,0,0,0],
      [0,0,0,4,4,4,0,0,0,0],
      [0,0,0,4,0,4,0,0,0,0],
      [0,0,0,4,0,4,0,0,0,0],
    ],
    palette: {0:null,1:'#e2e8f0',2:'#1e293b',3:'#475569',4:'#cbd5e1'}
  },
  orc: {
    pattern: [
      [0,0,1,1,1,1,1,0,0,0],
      [0,1,2,2,2,2,2,1,0,0],
      [0,1,3,2,2,3,2,1,0,0],
      [0,1,2,2,4,2,2,1,0,0],
      [0,0,1,4,4,4,1,0,0,0],
      [0,0,5,5,5,5,5,0,0,0],
      [0,5,5,5,5,5,5,5,0,0],
      [5,5,5,5,5,5,5,5,5,0],
      [0,5,0,5,0,5,0,5,0,0],
      [0,6,0,6,0,6,0,6,0,0],
    ],
    palette: {0:null,1:'#374151',2:'#059669',3:'#dc2626',4:'#fbbf24',5:'#4b5563',6:'#374151'}
  },
  mage: {
    pattern: [
      [0,0,1,1,1,1,1,0,0,0],
      [0,1,1,1,1,1,1,1,0,0],
      [0,0,2,3,2,3,2,0,0,0],
      [0,0,2,2,2,2,2,0,0,0],
      [0,0,0,2,4,2,0,0,0,0],
      [0,5,5,5,5,5,5,5,0,0],
      [5,5,5,5,5,5,5,5,5,0],
      [5,5,5,5,5,5,5,5,5,0],
      [0,5,5,5,5,5,5,5,0,0],
      [0,0,0,6,0,6,0,0,0,0],
    ],
    palette: {0:null,1:'#7c3aed',2:'#fde68a',3:'#06b6d4',4:'#f87171',5:'#5b21b6',6:'#4c1d95'}
  },
  dragon: {
    pattern: [
      [0,1,0,0,0,0,0,1,0,0],
      [1,2,1,0,0,0,1,2,1,0],
      [0,1,2,2,2,2,2,1,0,0],
      [0,0,2,3,2,3,2,0,0,0],
      [0,0,2,2,4,2,2,0,0,0],
      [0,2,2,2,2,2,2,2,0,0],
      [2,2,5,2,2,2,5,2,2,0],
      [2,2,2,2,2,2,2,2,2,0],
      [0,2,2,2,2,2,2,2,0,0],
      [0,0,6,0,0,0,6,0,0,0],
    ],
    palette: {0:null,1:'#fbbf24',2:'#dc2626',3:'#fef08a',4:'#f97316',5:'#fbbf24',6:'#991b1b'}
  },
  lich: {
    pattern: [
      [0,0,1,1,1,1,1,0,0,0],
      [0,1,1,1,1,1,1,1,0,0],
      [0,1,2,1,1,2,1,1,0,0],
      [0,1,1,1,3,1,1,1,0,0],
      [0,0,1,1,1,1,1,0,0,0],
      [0,4,4,4,4,4,4,4,0,0],
      [4,4,5,4,4,4,5,4,4,0],
      [4,4,4,4,4,4,4,4,4,0],
      [0,4,4,4,4,4,4,4,0,0],
      [0,0,6,0,0,0,6,0,0,0],
    ],
    palette: {0:null,1:'#374151',2:'#a855f7',3:'#6b21a8',4:'#1f2937',5:'#c084fc',6:'#4b5563'}
  },
};

// =====================================================================
// ZONES & QUESTIONS
// =====================================================================
const ZONES = [
  {
    id: 0, name: 'Binary Caverns', icon: '\u2699', enemyType: 'goblin', enemyName: 'BIT GOBLIN',
    hp: 60, bossHp: 120, enemies: 3,
    questions: [
      { q: 'What is 10010110 in decimal?', opts: ['148','150','146','152'], c: 1 },
      { q: 'What is 11100010 in decimal?', opts: ['224','226','228','230'], c: 1 },
      { q: 'What is 01010101 in decimal?', opts: ['85','87','83','81'], c: 0 },
      { q: 'Binary for 240?', opts: ['11110000','11100000','11111000','11001100'], c: 0 },
      { q: 'How many octets in an IPv4 address?', opts: ['2','4','8','16'], c: 1 },
      { q: 'What is 10000001 in decimal?', opts: ['127','128','129','131'], c: 2 },
    ],
    boss: { ip: '192.168.1.100', cidr: 24 },
  },
  {
    id: 1, name: 'Hex Highlands', icon: '\u2B21', enemyType: 'skeleton', enemyName: 'HEX WRAITH',
    hp: 70, bossHp: 140, enemies: 3,
    questions: [
      { q: '0xAB in decimal?', opts: ['171','170','175','168'], c: 0 },
      { q: '0x2F in decimal?', opts: ['45','47','49','43'], c: 1 },
      { q: 'Decimal 144 in hex?', opts: ['0x90','0x8F','0x91','0xA0'], c: 0 },
      { q: 'Hex digit B equals?', opts: ['10','11','12','13'], c: 1 },
      { q: '16^1 equals?', opts: ['8','16','32','64'], c: 1 },
      { q: '0x64 in decimal?', opts: ['96','100','104','108'], c: 1 },
    ],
    boss: { ip: '10.50.100.200', cidr: 22 },
  },
  {
    id: 2, name: 'Class Kingdom', icon: '\u265A', enemyType: 'orc', enemyName: 'CLASS ORC',
    hp: 80, bossHp: 160, enemies: 4,
    questions: [
      { q: 'What class is 200.10.5.1?', opts: ['A','B','C','D'], c: 2 },
      { q: 'What class is 44.200.1.1?', opts: ['A','B','C','D'], c: 0 },
      { q: 'What class is 150.100.50.1?', opts: ['A','B','C','D'], c: 1 },
      { q: 'Class C first octet range?', opts: ['0-127','128-191','192-223','224-239'], c: 2 },
      { q: 'Default Class B mask?', opts: ['255.0.0.0','255.255.0.0','255.255.255.0','/24'], c: 1 },
      { q: '169.254.x.x is for?', opts: ['Gateway','Loopback','APIPA','DNS'], c: 2 },
      { q: 'Class D is used for?', opts: ['Unicast','Multicast','Broadcast','Reserved'], c: 1 },
      { q: 'How many host bits in Class A default?', opts: ['8','16','24','32'], c: 2 },
    ],
    boss: { ip: '172.16.45.200', cidr: 22 },
  },
  {
    id: 3, name: 'Mask Marshlands', icon: '\u2620', enemyType: 'mage', enemyName: 'CIDR MAGE',
    hp: 90, bossHp: 180, enemies: 4,
    questions: [
      { q: 'Mask for /25?', opts: ['.64','.128','.192','.224'], c: 1 },
      { q: 'Mask for /22?', opts: ['255.255.252.0','255.255.248.0','255.255.240.0','255.255.254.0'], c: 0 },
      { q: '255.255.255.240 in CIDR?', opts: ['/26','/27','/28','/29'], c: 2 },
      { q: 'Mask for /30?', opts: ['.248','.252','.240','.224'], c: 1 },
      { q: 'Block size for /28?', opts: ['8','16','32','64'], c: 1 },
      { q: 'Usable hosts in /25?', opts: ['128','126','124','130'], c: 1 },
      { q: 'Usable hosts in /30?', opts: ['4','2','1','6'], c: 1 },
      { q: 'Wildcard for /24?', opts: ['0.0.0.255','0.0.0.127','0.0.0.63','0.0.1.255'], c: 0 },
    ],
    boss: { ip: '192.168.5.130', cidr: 26 },
  },
  {
    id: 4, name: 'Subnet Stronghold', icon: '\u26E8', enemyType: 'dragon', enemyName: 'SUBNET DRAGON',
    hp: 100, bossHp: 200, enemies: 5,
    questions: [
      { q: 'Network for 10.1.1.50/24?', opts: ['10.1.1.0','10.1.0.0','10.1.1.32','10.1.1.48'], c: 0 },
      { q: 'Network for 192.168.10.200/25?', opts: ['.0','.64','.128','.192'], c: 2 },
      { q: 'Broadcast for 10.0.0.0/24?', opts: ['10.0.0.254','10.0.0.255','10.0.1.0','10.0.0.128'], c: 1 },
      { q: 'First host in 172.16.0.0/20?', opts: ['172.16.0.0','172.16.0.1','172.16.1.0','172.16.0.2'], c: 1 },
      { q: 'Last host in 192.168.1.0/27?', opts: ['.30','.31','.32','.29'], c: 0 },
      { q: 'Broadcast for 10.10.10.128/25?', opts: ['10.10.10.254','10.10.10.255','10.10.10.191','10.10.10.127'], c: 1 },
      { q: 'Network for 172.16.100.50/20?', opts: ['172.16.96.0','172.16.100.0','172.16.80.0','172.16.64.0'], c: 0 },
      { q: 'Block size for /25?', opts: ['64','128','256','32'], c: 1 },
    ],
    boss: { ip: '10.200.20.100', cidr: 27 },
  },
  {
    id: 5, name: 'Final Fortress', icon: '\u2694', enemyType: 'lich', enemyName: 'LICH KING',
    hp: 120, bossHp: 250, enemies: 5,
    questions: [
      { q: 'VLSM means?', opts: ['Variable Length Subnet Mask','Very Large Subnet Map','Virtual LAN Subnet Mode','Variable Link State Method'], c: 0 },
      { q: 'How many /28s in a /24?', opts: ['4','8','16','32'], c: 2 },
      { q: 'Classful routing uses?', opts: ['One mask per class','Variable masks','No masks','CIDR notation'], c: 0 },
      { q: 'How many /24s from 10.0.0.0/8?', opts: ['256','1024','65536','16777216'], c: 2 },
      { q: 'Private Class B range?', opts: ['172.16-31.x.x','10.x.x.x','192.168.x.x','169.254.x.x'], c: 0 },
      { q: 'Network for 10.200.20.100/27?', opts: ['10.200.20.96','10.200.20.64','10.200.20.100','10.200.20.128'], c: 0 },
      { q: 'Broadcast for 192.168.1.0/28?', opts: ['192.168.1.15','192.168.1.16','192.168.1.31','192.168.1.255'], c: 0 },
      { q: 'VLSM: allocate which first?', opts: ['Largest subnet','Smallest subnet','Alphabetical','Random'], c: 0 },
    ],
    boss: { ip: '158.157.68.25', cidr: 18 },
  },
];

// =====================================================================
// SUBNET CALC
// =====================================================================
function ipToInt(ip) { return ip.split('.').reduce((a, o) => (a << 8) + parseInt(o), 0) >>> 0; }
function intToIp(n) { return [n>>>24,(n>>>16)&0xff,(n>>>8)&0xff,n&0xff].join('.'); }
function cidrToMask(p) { return p === 0 ? 0 : (0xffffffff << (32 - p)) >>> 0; }
function calcSubnet(ipStr, prefix) {
  const ip = ipToInt(ipStr), mask = cidrToMask(prefix);
  const net = (ip & mask) >>> 0, bcast = (net | ~mask) >>> 0;
  const hb = 32 - prefix, total = Math.pow(2, hb);
  const hosts = hb > 1 ? total - 2 : (hb === 1 ? 2 : 1);
  return {
    network: intToIp(net), broadcast: intToIp(bcast), mask: intToIp(mask),
    usableHosts: hosts, firstUsable: intToIp(hb > 1 ? net + 1 : net),
    lastUsable: intToIp(hb > 1 ? bcast - 1 : bcast),
  };
}

// =====================================================================
// GAME STATE
// =====================================================================
let player = { hp: 100, maxHp: 100, level: 1, xp: 0, xpNext: 100 };
let zonesCleared = new Set();
let currentZone = null;
let currentEnemyIdx = 0;
let enemyHp = 0;
let enemyMaxHp = 0;
let isBoss = false;
let questionPool = [];
let battleActive = false;

function shuffle(arr) { const a = [...arr]; for (let i = a.length-1; i > 0; i--) { const j = Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }

// =====================================================================
// RENDER
// =====================================================================
function renderWorldMap() {
  const map = document.getElementById('worldMap');
  map.innerHTML = ZONES.map(z => {
    const cleared = zonesCleared.has(z.id);
    const locked = z.id > 0 && !zonesCleared.has(z.id - 1);
    const active = currentZone && currentZone.id === z.id;
    return `<div class="zone-card ${cleared?'cleared':''} ${locked?'locked':''} ${active?'active':''}" data-zone="${z.id}">
      <div class="zone-icon">${z.icon}</div>
      <div class="zone-num">ZONE ${z.id + 1}</div>
      <div class="zone-name">${z.name}</div>
    </div>`;
  }).join('');

  map.querySelectorAll('.zone-card:not(.locked)').forEach(card => {
    card.addEventListener('click', () => enterZone(parseInt(card.dataset.zone)));
  });
}

function updatePlayerStats() {
  document.getElementById('playerLvl').textContent = player.level;
  document.getElementById('playerXp').textContent = player.xp;
  document.getElementById('playerHpStat').textContent = player.hp;
  document.getElementById('zonesCleared').textContent = zonesCleared.size;
}

function updateBattleUI() {
  const pPct = Math.max(0, (player.hp / player.maxHp) * 100);
  document.getElementById('playerHpBar').style.width = pPct + '%';
  document.getElementById('playerHpText').textContent = `${Math.max(0,player.hp)}/${player.maxHp}`;

  const ePct = Math.max(0, (enemyHp / enemyMaxHp) * 100);
  document.getElementById('enemyHpBar').style.width = ePct + '%';
  document.getElementById('enemyHpText').textContent = `${Math.max(0,enemyHp)}/${enemyMaxHp}`;
}

function showDamage(targetId, amount, color) {
  const el = document.getElementById(targetId);
  const num = document.createElement('div');
  num.className = 'damage-num';
  num.style.color = color;
  num.textContent = amount > 0 ? `-${amount}` : 'MISS';
  num.style.left = '50%';
  num.style.top = '20%';
  document.getElementById('battleField').appendChild(num);
  setTimeout(() => num.remove(), 1000);
}

// =====================================================================
// BATTLE LOGIC
// =====================================================================
function enterZone(zoneId) {
  currentZone = ZONES[zoneId];
  currentEnemyIdx = 0;
  isBoss = false;
  player.hp = player.maxHp;
  questionPool = shuffle(currentZone.questions);
  battleActive = true;

  document.getElementById('battleScene').classList.add('active');
  renderWorldMap();
  startEnemy();
}

function startEnemy() {
  if (currentEnemyIdx >= currentZone.enemies) {
    // Boss time
    isBoss = true;
    enemyHp = currentZone.bossHp;
    enemyMaxHp = currentZone.bossHp;
    document.getElementById('enemyName').textContent = 'BOSS: ' + currentZone.enemyName;
  } else {
    isBoss = false;
    enemyHp = currentZone.hp;
    enemyMaxHp = currentZone.hp;
    document.getElementById('enemyName').textContent = currentZone.enemyName + ` ${currentEnemyIdx + 1}/${currentZone.enemies}`;
  }

  // Draw sprites
  drawPixelArt(document.getElementById('heroCanvas'), HERO_PATTERN, HERO_PALETTE);
  const eData = ENEMY_SPRITES[currentZone.enemyType];
  drawPixelArt(document.getElementById('enemyCanvas'), eData.pattern, eData.palette);

  updateBattleUI();
  document.getElementById('battleLog').textContent = isBoss ? 'BOSS FIGHT! Fill in the subnet details!' : 'Choose your attack!';

  if (isBoss) {
    showBossQuestion();
  } else {
    showQuestion();
  }
}

function bitRefHTML(bin) {
  const positions = [128,64,32,16,8,4,2,1];
  const posHTML = positions.map(p => `<span>${p}</span>`).join('');
  const digHTML = bin.split('').map(d =>
    `<span class="${d==='1'?'one':'zero'}">${d}</span>`
  ).join('');
  return `<div class="bit-ref"><div class="bit-positions">${posHTML}</div><div class="bit-digits">${digHTML}</div></div>`;
}

function showQuestion() {
  if (questionPool.length === 0) questionPool = shuffle(currentZone.questions);
  const q = questionPool.pop();

  const binMatch = q.q.match(/\b([01]{8})\b/);
  const qHTML = binMatch ? q.q.replace(binMatch[1], '<br>' + bitRefHTML(binMatch[1])) : q.q;

  const container = document.getElementById('battleQuestion');
  container.innerHTML = `
    <div class="bq-text">${qHTML}</div>
    <div class="battle-options">
      ${q.opts.map((o, i) => `<button class="battle-opt" data-idx="${i}">${o}</button>`).join('')}
    </div>
  `;

  container.querySelectorAll('.battle-opt').forEach(btn => {
    btn.addEventListener('click', () => handleBattleAnswer(parseInt(btn.dataset.idx), q.c, container));
  });
}

function handleBattleAnswer(idx, correct, container) {
  const btns = container.querySelectorAll('.battle-opt');
  btns.forEach((b, i) => {
    b.classList.add('disabled');
    if (i === correct) b.classList.add('correct');
    if (i === idx && i !== correct) b.classList.add('wrong');
  });

  if (idx === correct) {
    // Player attacks
    const dmg = 20 + Math.floor(Math.random() * 10) + player.level * 2;
    enemyHp -= dmg;
    showDamage('enemySprite', dmg, 'var(--accent-green)');
    document.getElementById('enemySprite').classList.add('shake');
    setTimeout(() => document.getElementById('enemySprite').classList.remove('shake'), 400);
    document.getElementById('battleLog').textContent = `You deal ${dmg} damage!`;
    gainXp(10);
  } else {
    // Enemy attacks
    const dmg = 10 + Math.floor(Math.random() * 8) + currentZone.id * 3;
    player.hp -= dmg;
    showDamage('playerSprite', dmg, 'var(--accent-red)');
    document.getElementById('playerSprite').classList.add('flash-red');
    setTimeout(() => document.getElementById('playerSprite').classList.remove('flash-red'), 300);
    document.getElementById('battleLog').textContent = `Enemy hits you for ${dmg}!`;
  }

  updateBattleUI();
  updatePlayerStats();

  setTimeout(() => {
    if (player.hp <= 0) {
      endBattle(false);
    } else if (enemyHp <= 0) {
      if (!isBoss) {
        currentEnemyIdx++;
        document.getElementById('battleLog').textContent = 'Enemy defeated!';
        setTimeout(() => startEnemy(), 800);
      } else {
        endBattle(true);
      }
    } else {
      showQuestion();
    }
  }, 800);
}

function showBossQuestion() {
  const boss = currentZone.boss;
  const answer = calcSubnet(boss.ip, boss.cidr);

  const container = document.getElementById('battleQuestion');
  container.innerHTML = `
    <div class="bq-text">SUBNET: ${boss.ip} /${boss.cidr}</div>
    <div class="boss-fields">
      <div class="boss-field"><label>Network</label><input type="text" id="bf-net" placeholder="?.?.?.?"></div>
      <div class="boss-field"><label>Broadcast</label><input type="text" id="bf-bcast" placeholder="?.?.?.?"></div>
      <div class="boss-field"><label>Mask</label><input type="text" id="bf-mask" placeholder="?.?.?.?"></div>
      <div class="boss-field"><label>Hosts</label><input type="text" id="bf-hosts" placeholder="?"></div>
      <div class="boss-field"><label>First Usable</label><input type="text" id="bf-first" placeholder="?.?.?.?"></div>
      <div class="boss-field"><label>Last Usable</label><input type="text" id="bf-last" placeholder="?.?.?.?"></div>
    </div>
    <div style="text-align:center;margin-top:0.75rem;">
      <button class="btn-action" id="bossSubmit">ATTACK!</button>
    </div>
  `;

  document.getElementById('bossSubmit').addEventListener('click', () => {
    const fields = [
      { id: 'bf-net', key: 'network' },
      { id: 'bf-bcast', key: 'broadcast' },
      { id: 'bf-mask', key: 'mask' },
      { id: 'bf-hosts', key: 'usableHosts' },
      { id: 'bf-first', key: 'firstUsable' },
      { id: 'bf-last', key: 'lastUsable' },
    ];

    let hits = 0;
    fields.forEach(f => {
      const inp = document.getElementById(f.id);
      const val = inp.value.trim();
      const correct = String(answer[f.key]);
      inp.classList.remove('correct-input', 'incorrect-input');
      if (val === correct) {
        inp.classList.add('correct-input');
        hits++;
      } else {
        inp.classList.add('incorrect-input');
      }
    });

    if (hits === 6) {
      // Critical hit!
      const dmg = 100 + player.level * 10;
      enemyHp -= dmg;
      showDamage('enemySprite', dmg, 'var(--accent-amber)');
      document.getElementById('battleLog').textContent = `CRITICAL HIT! ${dmg} damage! All fields correct!`;
      gainXp(50);
    } else if (hits > 0) {
      const dmg = hits * 15;
      enemyHp -= dmg;
      showDamage('enemySprite', dmg, 'var(--accent-green)');
      document.getElementById('battleLog').textContent = `${hits}/6 correct \u2014 ${dmg} damage!`;
      const eDmg = (6 - hits) * 5;
      player.hp -= eDmg;
      showDamage('playerSprite', eDmg, 'var(--accent-red)');
      gainXp(hits * 5);
    } else {
      const eDmg = 25 + currentZone.id * 5;
      player.hp -= eDmg;
      showDamage('playerSprite', eDmg, 'var(--accent-red)');
      document.getElementById('battleLog').textContent = `0/6 correct \u2014 Boss hits you for ${eDmg}!`;
    }

    document.getElementById('enemySprite').classList.add('shake');
    setTimeout(() => document.getElementById('enemySprite').classList.remove('shake'), 400);

    updateBattleUI();
    updatePlayerStats();

    setTimeout(() => {
      if (player.hp <= 0) {
        endBattle(false);
      } else if (enemyHp <= 0) {
        endBattle(true);
      } else {
        showBossQuestion();
      }
    }, 1000);
  });
}

function endBattle(victory) {
  battleActive = false;
  if (victory) {
    zonesCleared.add(currentZone.id);
    gainXp(50 + currentZone.id * 20);
    document.getElementById('battleLog').textContent = `Zone cleared! ${currentZone.name} conquered!`;
    document.getElementById('battleQuestion').innerHTML = `
      <div style="text-align:center;">
        <div class="bq-text" style="color:var(--accent-green);">VICTORY!</div>
        <button class="btn-action green" id="btnBackMap">BACK TO MAP</button>
      </div>
    `;
  } else {
    document.getElementById('battleLog').textContent = 'You were defeated... Try again!';
    document.getElementById('battleQuestion').innerHTML = `
      <div style="text-align:center;">
        <div class="bq-text" style="color:var(--accent-red);">DEFEATED</div>
        <button class="btn-action" id="btnBackMap">BACK TO MAP</button>
      </div>
    `;
  }

  document.getElementById('btnBackMap').addEventListener('click', () => {
    document.getElementById('battleScene').classList.remove('active');
    currentZone = null;
    renderWorldMap();
    updatePlayerStats();
  });
}

function gainXp(amount) {
  player.xp += amount;
  while (player.xp >= player.xpNext) {
    player.xp -= player.xpNext;
    player.level++;
    player.maxHp += 10;
    player.hp = player.maxHp;
    player.xpNext = Math.floor(player.xpNext * 1.3);
  }
}

// =====================================================================
// INIT
// =====================================================================
renderWorldMap();
updatePlayerStats();
drawPixelArt(document.getElementById('heroCanvas'), HERO_PATTERN, HERO_PALETTE);
</script>
</body>
</html>
