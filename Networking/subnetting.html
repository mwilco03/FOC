<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NetDrill - Networking Fundamentals</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&family=Space+Grotesk:wght@400;500;600;700&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --bg-primary: #0a0e17;
  --bg-secondary: #111827;
  --bg-card: #1a2235;
  --bg-card-hover: #1f2a40;
  --border: #2a3650;
  --border-active: #3b82f6;
  --text-primary: #e2e8f0;
  --text-secondary: #94a3b8;
  --text-muted: #64748b;
  --accent-blue: #3b82f6;
  --accent-cyan: #06b6d4;
  --accent-green: #10b981;
  --accent-amber: #f59e0b;
  --accent-red: #ef4444;
  --accent-purple: #8b5cf6;
  --accent-pink: #ec4899;
  --layer-7: #ec4899;
  --layer-6: #a855f7;
  --layer-5: #8b5cf6;
  --layer-4: #3b82f6;
  --layer-3: #06b6d4;
  --layer-2: #10b981;
  --layer-1: #f59e0b;
  --radius: 8px;
  --radius-lg: 12px;
  --shadow: 0 4px 24px rgba(0,0,0,0.3);
  --transition: 0.2s ease;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'DM Sans', sans-serif;
  background: var(--bg-primary);
  color: var(--text-primary);
  min-height: 100vh;
  overflow-x: hidden;
}

body::before {
  content: '';
  position: fixed;
  inset: 0;
  background:
    linear-gradient(rgba(59,130,246,0.03) 1px, transparent 1px),
    linear-gradient(90deg, rgba(59,130,246,0.03) 1px, transparent 1px);
  background-size: 60px 60px;
  pointer-events: none;
  z-index: 0;
}

.app { position: relative; z-index: 1; }

.header {
  padding: 2rem 2rem 1rem;
  text-align: center;
  border-bottom: 1px solid var(--border);
  background: linear-gradient(180deg, rgba(59,130,246,0.06) 0%, transparent 100%);
}

.header h1 {
  font-family: 'JetBrains Mono', monospace;
  font-size: 2.2rem;
  font-weight: 700;
  letter-spacing: -1px;
  background: linear-gradient(135deg, var(--accent-cyan), var(--accent-blue), var(--accent-purple));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  margin-bottom: 0.25rem;
}

.header p {
  color: var(--text-muted);
  font-size: 0.9rem;
}

.header .course-name {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.72rem;
  color: var(--accent-cyan);
  text-transform: uppercase;
  letter-spacing: 2px;
  margin-bottom: 0.5rem;
}

/* Tab navigation */
.tabs {
  display: flex;
  justify-content: center;
  gap: 0.5rem;
  padding: 1rem 2rem;
  border-bottom: 1px solid var(--border);
  flex-wrap: wrap;
}

.tab-btn {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.78rem;
  padding: 0.55rem 1.1rem;
  border: 1px solid var(--border);
  border-radius: 999px;
  background: var(--bg-secondary);
  color: var(--text-secondary);
  cursor: pointer;
  transition: all var(--transition);
  white-space: nowrap;
}

.tab-btn:hover {
  border-color: var(--accent-blue);
  color: var(--text-primary);
}

.tab-btn.active {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
  color: #fff;
}

.content {
  max-width: 1100px;
  margin: 0 auto;
  padding: 2rem;
}

.section { display: none; }
.section.active { display: block; animation: fadeIn 0.3s ease; }

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}

.section-header { margin-bottom: 1.5rem; }

.section-header h2 {
  font-family: 'JetBrains Mono', monospace;
  font-size: 1.4rem;
  font-weight: 600;
  margin-bottom: 0.3rem;
}

.section-header p {
  color: var(--text-muted);
  font-size: 0.88rem;
}

/* =================== OSI DRAG & DROP =================== */
.osi-layout {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 2rem;
  align-items: start;
}

@media (max-width: 768px) {
  .osi-layout { grid-template-columns: 1fr; }
}

.layer-stack {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.layer-slot {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 0.6rem 1rem;
  border: 2px dashed var(--border);
  border-radius: var(--radius);
  min-height: 52px;
  transition: all var(--transition);
  position: relative;
}

.layer-slot.drag-over {
  border-color: var(--accent-blue);
  background: rgba(59,130,246,0.08);
}

.layer-slot.correct {
  border-color: var(--accent-green);
  border-style: solid;
  background: rgba(16,185,129,0.08);
}

.layer-slot.incorrect {
  border-color: var(--accent-red);
  border-style: solid;
  background: rgba(239,68,68,0.08);
  animation: shake 0.4s ease;
}

@keyframes shake {
  0%,100% { transform: translateX(0); }
  25% { transform: translateX(-4px); }
  75% { transform: translateX(4px); }
}

.layer-num {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.75rem;
  font-weight: 700;
  width: 28px;
  height: 28px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  color: #fff;
}

.layer-slot-label {
  font-size: 0.82rem;
  color: var(--text-muted);
  font-style: italic;
}

.layer-slot .placed-item {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.82rem;
  font-weight: 500;
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.layer-slot .placed-item .remove-x {
  font-size: 0.7rem;
  color: var(--accent-red);
  opacity: 0.5;
  margin-left: 0.25rem;
  transition: opacity var(--transition);
}

.layer-slot .placed-item:hover .remove-x {
  opacity: 1;
}

.layer-addressing {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.65rem;
  color: var(--text-muted);
  margin-left: auto;
  text-align: right;
  flex-shrink: 0;
  line-height: 1.4;
}

.layer-addressing .addr-type {
  color: var(--accent-amber);
  font-weight: 600;
}

.layer-addressing .addr-pdu {
  color: var(--text-muted);
}

/* Drag items pool */
.drag-pool {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 1.25rem;
}

.drag-pool h3 {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.85rem;
  color: var(--text-muted);
  margin-bottom: 1rem;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.drag-items {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
}

.drag-item {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.82rem;
  padding: 0.5rem 1rem;
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: 999px;
  cursor: grab;
  transition: all var(--transition);
  user-select: none;
  color: var(--text-primary);
}

.drag-item:hover {
  border-color: var(--accent-blue);
  transform: translateY(-1px);
}

.drag-item:active { cursor: grabbing; }

.drag-item.placed {
  opacity: 0.3;
  pointer-events: none;
}

/* Controls bar */
.controls {
  display: flex;
  gap: 0.75rem;
  margin-top: 1.5rem;
  flex-wrap: wrap;
}

.btn {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.82rem;
  padding: 0.6rem 1.4rem;
  border-radius: var(--radius);
  border: 1px solid var(--border);
  cursor: pointer;
  transition: all var(--transition);
  background: var(--bg-card);
  color: var(--text-primary);
}

.btn:hover { border-color: var(--accent-blue); }

.btn-primary {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
  color: #fff;
}

.btn-primary:hover { background: #2563eb; }

.btn-green {
  background: var(--accent-green);
  border-color: var(--accent-green);
  color: #fff;
}

.btn-green:hover { background: #059669; }

.score-display {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.85rem;
  color: var(--accent-green);
  display: flex;
  align-items: center;
  margin-left: auto;
}

/* =================== PROTOCOL MATCHING =================== */
.protocol-game {
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
}

.protocol-question {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 1.5rem;
  transition: all var(--transition);
}

.protocol-question.answered-correct {
  border-color: var(--accent-green);
  background: rgba(16,185,129,0.05);
}

.protocol-question.answered-wrong {
  border-color: var(--accent-red);
  background: rgba(239,68,68,0.05);
}

.pq-prompt {
  font-family: 'JetBrains Mono', monospace;
  font-size: 1rem;
  font-weight: 600;
  margin-bottom: 0.4rem;
}

.pq-hint {
  font-size: 0.82rem;
  color: var(--text-muted);
  margin-bottom: 1rem;
}

.pq-options {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
}

.pq-option {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.8rem;
  padding: 0.45rem 1rem;
  border: 1px solid var(--border);
  border-radius: 999px;
  background: var(--bg-secondary);
  color: var(--text-secondary);
  cursor: pointer;
  transition: all var(--transition);
}

.pq-option:hover:not(.disabled) {
  border-color: var(--accent-blue);
  color: var(--text-primary);
}

.pq-option.selected-correct {
  background: var(--accent-green);
  border-color: var(--accent-green);
  color: #fff;
}

.pq-option.selected-wrong {
  background: var(--accent-red);
  border-color: var(--accent-red);
  color: #fff;
}

.pq-option.show-correct {
  border-color: var(--accent-green);
  color: var(--accent-green);
}

.pq-option.disabled { pointer-events: none; }

.pq-explanation {
  margin-top: 0.75rem;
  font-size: 0.82rem;
  color: var(--text-secondary);
  padding: 0.75rem;
  background: rgba(59,130,246,0.06);
  border-radius: var(--radius);
  display: none;
}

.pq-explanation.visible { display: block; animation: fadeIn 0.3s ease; }

/* =================== NUMBER SYSTEMS =================== */
.numsys-layout {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 2rem;
  align-items: start;
}

@media (max-width: 768px) {
  .numsys-layout { grid-template-columns: 1fr; }
}

.converter-panel {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 1.5rem;
}

.converter-panel h3 {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.95rem;
  font-weight: 600;
  margin-bottom: 1rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.converter-row {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  margin-bottom: 0.75rem;
}

.converter-row label {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.75rem;
  color: var(--text-muted);
  width: 40px;
  flex-shrink: 0;
  text-transform: uppercase;
}

.converter-row input {
  flex: 1;
  padding: 0.6rem 0.8rem;
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.95rem;
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  color: var(--text-primary);
  outline: none;
  transition: border-color var(--transition);
}

.converter-row input:focus {
  border-color: var(--accent-blue);
}

.bit-chart {
  display: grid;
  grid-template-columns: repeat(8, 1fr);
  gap: 2px;
  margin-top: 1rem;
}

.bit-cell {
  text-align: center;
  padding: 0.4rem;
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.72rem;
  border-radius: 4px;
}

.bit-cell.header {
  background: var(--bg-secondary);
  color: var(--accent-cyan);
  font-weight: 700;
  font-size: 0.8rem;
}

.bit-cell.value {
  background: rgba(59,130,246,0.08);
  color: var(--text-secondary);
  cursor: pointer;
  transition: all var(--transition);
  border: 1px solid transparent;
}

.bit-cell.value:hover {
  border-color: var(--accent-blue);
}

.bit-cell.value.active {
  background: var(--accent-blue);
  color: #fff;
  font-weight: 700;
}

.bit-total {
  grid-column: 1 / -1;
  text-align: center;
  padding: 0.6rem;
  font-family: 'JetBrains Mono', monospace;
  font-size: 1rem;
  color: var(--accent-green);
  font-weight: 700;
  margin-top: 0.25rem;
}

/* Number drill */
.drill-display {
  text-align: center;
  padding: 1.5rem;
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  margin-bottom: 1rem;
}

.drill-display .drill-base {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.72rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 0.3rem;
}

.drill-display .drill-value {
  font-family: 'JetBrains Mono', monospace;
  font-size: 2rem;
  font-weight: 700;
  color: var(--accent-cyan);
}

.drill-input-row {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 0.5rem;
}

.drill-input-row label {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.75rem;
  color: var(--text-muted);
  width: 40px;
  display: flex;
  align-items: center;
  flex-shrink: 0;
}

.drill-input-row input {
  flex: 1;
  padding: 0.5rem 0.7rem;
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.9rem;
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  color: var(--text-primary);
  outline: none;
}

.drill-input-row input:focus { border-color: var(--accent-blue); }
.drill-input-row input.correct-input { border-color: var(--accent-green); background: rgba(16,185,129,0.08); }
.drill-input-row input.incorrect-input { border-color: var(--accent-red); background: rgba(239,68,68,0.08); }

/* Power of 2 chart */
.powers-chart {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
  gap: 4px;
  margin-top: 1rem;
}

.power-cell {
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 0.5rem;
  text-align: center;
  font-family: 'JetBrains Mono', monospace;
}

.power-cell .exp {
  font-size: 0.65rem;
  color: var(--text-muted);
}

.power-cell .val {
  font-size: 0.82rem;
  color: var(--accent-cyan);
  font-weight: 600;
}

/* hex chart */
.hex-chart {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
  gap: 4px;
  margin-top: 1rem;
}

.hex-cell {
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 0.45rem;
  text-align: center;
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.8rem;
  display: flex;
  justify-content: space-between;
  gap: 0.25rem;
}

.hex-cell .hc-dec { color: var(--text-secondary); }
.hex-cell .hc-hex { color: var(--accent-purple); font-weight: 600; }
.hex-cell .hc-bin { color: var(--accent-cyan); font-size: 0.68rem; }

/* =================== SUBNET MATH =================== */
.math-drill-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 1.5rem;
  margin-bottom: 1.5rem;
}

.math-drill-card h3 {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.95rem;
  font-weight: 600;
  margin-bottom: 0.3rem;
}

.math-drill-card .drill-desc {
  font-size: 0.8rem;
  color: var(--text-muted);
  margin-bottom: 1rem;
}

.math-problem {
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 1rem;
  margin-bottom: 1rem;
}

.math-problem .mp-question {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.95rem;
  color: var(--text-primary);
  margin-bottom: 0.75rem;
}

.math-problem .mp-input-row {
  display: flex;
  gap: 0.5rem;
  align-items: center;
}

.math-problem .mp-input-row input {
  flex: 1;
  padding: 0.5rem 0.7rem;
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.9rem;
  background: var(--bg-primary);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  color: var(--text-primary);
  outline: none;
}

.math-problem .mp-input-row input:focus { border-color: var(--accent-blue); }
.math-problem .mp-input-row input.correct-input { border-color: var(--accent-green); background: rgba(16,185,129,0.08); }
.math-problem .mp-input-row input.incorrect-input { border-color: var(--accent-red); background: rgba(239,68,68,0.08); }

.math-problem .mp-feedback {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.78rem;
  margin-top: 0.5rem;
  padding: 0.4rem 0.6rem;
  border-radius: 4px;
  display: none;
}

.math-problem .mp-feedback.visible { display: block; }
.math-problem .mp-feedback.correct { color: var(--accent-green); background: rgba(16,185,129,0.1); }
.math-problem .mp-feedback.wrong { color: var(--accent-red); background: rgba(239,68,68,0.1); }

.streak-bar {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  margin-bottom: 1rem;
}

.streak-bar .streak-label {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.78rem;
  color: var(--text-muted);
}

.streak-bar .streak-count {
  font-family: 'JetBrains Mono', monospace;
  font-size: 1rem;
  font-weight: 700;
  color: var(--accent-green);
}

.streak-dots {
  display: flex;
  gap: 3px;
}

.streak-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--border);
  transition: all var(--transition);
}

.streak-dot.correct { background: var(--accent-green); }
.streak-dot.wrong { background: var(--accent-red); }

/* =================== SUBNETTING =================== */
.subnet-tool {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 2rem;
  align-items: start;
}

@media (max-width: 768px) {
  .subnet-tool { grid-template-columns: 1fr; }
}

.subnet-panel {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 1.5rem;
}

.subnet-panel h3 {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.95rem;
  font-weight: 600;
  margin-bottom: 1rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.input-group { margin-bottom: 1rem; }

.input-group label {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.75rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  display: block;
  margin-bottom: 0.35rem;
}

.input-group input, .input-group select {
  width: 100%;
  padding: 0.6rem 0.8rem;
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.88rem;
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  color: var(--text-primary);
  outline: none;
  transition: border-color var(--transition);
}

.input-group input:focus, .input-group select:focus {
  border-color: var(--accent-blue);
}

.result-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 0.75rem;
}

.result-item {
  padding: 0.7rem;
  background: var(--bg-secondary);
  border-radius: var(--radius);
  border: 1px solid var(--border);
}

.result-item .ri-label {
  font-size: 0.7rem;
  font-family: 'JetBrains Mono', monospace;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 0.2rem;
}

.result-item .ri-value {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.85rem;
  color: var(--accent-cyan);
  word-break: break-all;
}

.result-item.full-width { grid-column: 1 / -1; }

.binary-display {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.78rem;
  padding: 0.75rem;
  background: var(--bg-secondary);
  border-radius: var(--radius);
  border: 1px solid var(--border);
  margin-top: 1rem;
  line-height: 1.8;
  word-break: break-all;
}

.binary-display .octet { color: var(--accent-cyan); }
.binary-display .network-bits { color: var(--accent-green); }
.binary-display .host-bits { color: var(--accent-amber); }
.binary-display .separator { color: var(--text-muted); }

/* Subnet practice */
.practice-prompt {
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 1rem;
  margin-bottom: 1rem;
}

.practice-prompt .pp-label {
  font-size: 0.7rem;
  font-family: 'JetBrains Mono', monospace;
  color: var(--text-muted);
  text-transform: uppercase;
  margin-bottom: 0.3rem;
}

.practice-prompt .pp-value {
  font-family: 'JetBrains Mono', monospace;
  font-size: 1.1rem;
  color: var(--accent-cyan);
}

.practice-fields {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
  margin-bottom: 1rem;
}

.practice-field {
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.practice-field label {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.75rem;
  color: var(--text-muted);
  width: 120px;
  flex-shrink: 0;
}

.practice-field input {
  flex: 1;
  padding: 0.5rem 0.7rem;
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.85rem;
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  color: var(--text-primary);
  outline: none;
  transition: border-color var(--transition);
}

.practice-field input:focus { border-color: var(--accent-blue); }
.practice-field input.correct-input { border-color: var(--accent-green); background: rgba(16,185,129,0.08); }
.practice-field input.incorrect-input { border-color: var(--accent-red); background: rgba(239,68,68,0.08); }

.practice-feedback {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.82rem;
  padding: 0.75rem;
  border-radius: var(--radius);
  margin-top: 0.5rem;
  display: none;
}

.practice-feedback.visible { display: block; }
.practice-feedback.success {
  background: rgba(16,185,129,0.1);
  color: var(--accent-green);
  border: 1px solid rgba(16,185,129,0.2);
}
.practice-feedback.error {
  background: rgba(239,68,68,0.1);
  color: var(--accent-red);
  border: 1px solid rgba(239,68,68,0.2);
}

/* =================== REFERENCE TABLE =================== */
.ref-table-wrapper {
  overflow-x: auto;
  margin-top: 1rem;
}

.ref-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.82rem;
}

.ref-table th {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.72rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-muted);
  padding: 0.6rem 0.8rem;
  text-align: left;
  border-bottom: 1px solid var(--border);
  position: sticky;
  top: 0;
  background: var(--bg-card);
}

.ref-table td {
  padding: 0.55rem 0.8rem;
  border-bottom: 1px solid rgba(42,54,80,0.5);
  color: var(--text-secondary);
}

.ref-table tr:hover td {
  background: rgba(59,130,246,0.04);
}

.ref-table .layer-badge {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.72rem;
  font-weight: 600;
  padding: 0.2rem 0.5rem;
  border-radius: 999px;
  color: #fff;
  white-space: nowrap;
}

.ref-table .proto-name {
  font-family: 'JetBrains Mono', monospace;
  font-weight: 500;
  color: var(--text-primary);
}

/* CIDR cheat sheet */
.cidr-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
  gap: 0.5rem;
  margin-top: 1rem;
}

.cidr-card {
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 0.65rem 0.85rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.8rem;
}

.cidr-card .cidr-prefix { color: var(--accent-cyan); font-weight: 600; }
.cidr-card .cidr-hosts { color: var(--text-muted); font-size: 0.72rem; }

/* =================== WILDCARD / BITWISE =================== */
.bitwise-viz {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.82rem;
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 1rem;
  margin-top: 1rem;
  overflow-x: auto;
}

.bitwise-row {
  display: flex;
  gap: 0.5rem;
  align-items: center;
  margin-bottom: 0.35rem;
}

.bitwise-row .bw-label {
  width: 80px;
  color: var(--text-muted);
  font-size: 0.72rem;
  flex-shrink: 0;
}

.bitwise-row .bw-bits {
  display: flex;
  gap: 1px;
}

.bitwise-row .bw-bit {
  width: 18px;
  height: 22px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.72rem;
  border-radius: 2px;
}

.bw-bit.one { background: var(--accent-green); color: #fff; }
.bw-bit.zero { background: rgba(239,68,68,0.2); color: var(--accent-red); }
.bw-bit.sep { background: transparent; color: var(--text-muted); width: 8px; }

/* Responsive */
@media (max-width: 600px) {
  .content { padding: 1rem; }
  .header h1 { font-size: 1.6rem; }
  .osi-layout, .subnet-tool, .numsys-layout { gap: 1rem; }
  .result-grid { grid-template-columns: 1fr; }
}
</style>
</head>
<body>

<div class="app">
  <header class="header">
    <div class="course-name">Networking Fundamentals</div>
    <h1>&gt; NetDrill_</h1>
    <p>Interactive networking practice &amp; memorization tools</p>
  </header>

  <nav class="tabs">
    <button class="tab-btn active" data-tab="osi-drag">OSI Layers</button>
    <button class="tab-btn" data-tab="protocol-match">Protocol Quiz</button>
    <button class="tab-btn" data-tab="number-systems">Number Systems</button>
    <button class="tab-btn" data-tab="subnet-math">Subnet Math</button>
    <button class="tab-btn" data-tab="subnet-calc">Subnet Calc</button>
    <button class="tab-btn" data-tab="subnet-practice">Subnet Practice</button>
    <button class="tab-btn" data-tab="reference">Reference</button>
  </nav>

  <main class="content">

    <!-- ============ OSI DRAG & DROP ============ -->
    <section id="osi-drag" class="section active">
      <div class="section-header">
        <h2>OSI Model Drag &amp; Drop</h2>
        <p>Drag each layer name to its correct position. Click a placed item to remove it. Note the addressing &amp; PDU for each layer.</p>
      </div>
      <div class="osi-layout">
        <div class="layer-stack" id="layerStack"></div>
        <div class="drag-pool">
          <h3>Layer Names</h3>
          <div class="drag-items" id="dragItems"></div>
          <div style="margin-top:1.25rem;padding-top:1rem;border-top:1px solid var(--border);">
            <h3 style="font-size:0.78rem;margin-bottom:0.75rem;">Addressing &amp; PDU Reference</h3>
            <div style="font-size:0.78rem;color:var(--text-secondary);line-height:1.8;">
              <div><span style="color:var(--layer-7);">L7-5</span> &rarr; <span style="color:var(--accent-amber);">Data</span></div>
              <div><span style="color:var(--layer-4);">L4</span> &rarr; <span style="color:var(--accent-amber);">Port Numbers</span> / Segments</div>
              <div><span style="color:var(--layer-3);">L3</span> &rarr; <span style="color:var(--accent-amber);">IP Address</span> / Packets</div>
              <div><span style="color:var(--layer-2);">L2</span> &rarr; <span style="color:var(--accent-amber);">MAC Address</span> / Frames</div>
              <div><span style="color:var(--layer-1);">L1</span> &rarr; <span style="color:var(--accent-amber);">Signals</span> / Bits</div>
            </div>
          </div>
        </div>
      </div>
      <div class="controls">
        <button class="btn btn-primary" id="osiCheck">Check Answers</button>
        <button class="btn" id="osiReset">Reset</button>
        <div class="score-display" id="osiScore"></div>
      </div>
    </section>

    <!-- ============ PROTOCOL QUIZ ============ -->
    <section id="protocol-match" class="section">
      <div class="section-header">
        <h2>Protocol &amp; Layer Quiz</h2>
        <p>For each item, select the correct OSI layer or answer</p>
      </div>
      <div class="protocol-game" id="protocolGame"></div>
      <div class="controls">
        <button class="btn" id="protoNew">New Questions</button>
        <div class="score-display" id="protoScore"></div>
      </div>
    </section>

    <!-- ============ NUMBER SYSTEMS ============ -->
    <section id="number-systems" class="section">
      <div class="section-header">
        <h2>Number Systems</h2>
        <p>Convert between binary, decimal &amp; hexadecimal. Toggle bits to build values. Drill until it's automatic.</p>
      </div>
      <div class="numsys-layout">
        <!-- Left: Converter + Bit Toggle -->
        <div>
          <div class="converter-panel">
            <h3>&#9654; Live Converter</h3>
            <div class="converter-row">
              <label>DEC</label>
              <input type="text" id="convDec" placeholder="0-255" value="0">
            </div>
            <div class="converter-row">
              <label>BIN</label>
              <input type="text" id="convBin" placeholder="00000000" value="00000000">
            </div>
            <div class="converter-row">
              <label>HEX</label>
              <input type="text" id="convHex" placeholder="00" value="00">
            </div>
          </div>

          <div class="converter-panel" style="margin-top:1rem;">
            <h3>&#9654; Bit Toggle (click bits)</h3>
            <div class="bit-chart" id="bitChart"></div>
            <div class="bit-total" id="bitTotal">= 0</div>
          </div>

          <div class="converter-panel" style="margin-top:1rem;">
            <h3>&#9654; Hex &#8596; Decimal &#8596; Binary (0-15)</h3>
            <div class="hex-chart" id="hexChart"></div>
          </div>
        </div>

        <!-- Right: Conversion Drill -->
        <div>
          <div class="converter-panel">
            <h3>&#9654; Conversion Drill</h3>
            <p style="font-size:0.8rem;color:var(--text-muted);margin-bottom:1rem;">Convert the given value to the other two bases (0-255 range)</p>
            <div class="drill-display" id="numDrillDisplay">
              <div class="drill-base" id="numDrillBase">--</div>
              <div class="drill-value" id="numDrillValue">--</div>
            </div>
            <div id="numDrillInputs"></div>
            <div class="controls" style="margin-top:0.75rem;">
              <button class="btn btn-primary" id="numDrillCheck">Check</button>
              <button class="btn" id="numDrillShow">Show Answer</button>
              <button class="btn" id="numDrillNext">Next</button>
              <div class="score-display" id="numDrillScore"></div>
            </div>
            <div class="streak-bar" style="margin-top:1rem;" id="numDrillStreak"></div>
          </div>

          <div class="converter-panel" style="margin-top:1rem;">
            <h3>&#9654; Powers of 2 Chart</h3>
            <p style="font-size:0.78rem;color:var(--text-muted);margin-bottom:0.5rem;">Essential for subnetting. Memorize these.</p>
            <div class="powers-chart" id="powersChart"></div>
          </div>

          <div class="converter-panel" style="margin-top:1rem;">
            <h3>&#9654; Subnet Magic Number</h3>
            <p style="font-size:0.78rem;color:var(--text-muted);line-height:1.6;">
              For any CIDR prefix, the <strong style="color:var(--accent-cyan);">magic number</strong> = 256 - (value of the interesting octet).<br>
              Block sizes: <span style="color:var(--accent-amber);">128, 64, 32, 16, 8, 4, 2, 1</span><br>
              These are the only valid subnet boundary increments.
            </p>
            <div class="powers-chart" style="grid-template-columns: repeat(4,1fr);margin-top:0.75rem;">
              <div class="power-cell"><div class="exp">256 - 128</div><div class="val">128</div></div>
              <div class="power-cell"><div class="exp">256 - 192</div><div class="val">64</div></div>
              <div class="power-cell"><div class="exp">256 - 224</div><div class="val">32</div></div>
              <div class="power-cell"><div class="exp">256 - 240</div><div class="val">16</div></div>
              <div class="power-cell"><div class="exp">256 - 248</div><div class="val">8</div></div>
              <div class="power-cell"><div class="exp">256 - 252</div><div class="val">4</div></div>
              <div class="power-cell"><div class="exp">256 - 254</div><div class="val">2</div></div>
              <div class="power-cell"><div class="exp">256 - 255</div><div class="val">1</div></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ============ SUBNET MATH DRILLS ============ -->
    <section id="subnet-math" class="section">
      <div class="section-header">
        <h2>Subnet Math Drills</h2>
        <p>Quick-fire drills to build subnetting speed. Answer and hit Enter.</p>
      </div>

      <!-- CIDR to Mask drill -->
      <div class="math-drill-card">
        <h3>CIDR &#8596; Subnet Mask</h3>
        <div class="drill-desc">Convert between CIDR notation and dotted-decimal subnet masks</div>
        <div class="streak-bar" id="cidrStreak"></div>
        <div class="math-problem" id="cidrProblem"></div>
        <div class="controls" style="margin-top:0;">
          <button class="btn btn-primary" id="cidrCheck">Check</button>
          <button class="btn" id="cidrShow">Show</button>
          <button class="btn" id="cidrNext">Next</button>
          <div class="score-display" id="cidrScore"></div>
        </div>
      </div>

      <!-- Hosts calculation drill -->
      <div class="math-drill-card">
        <h3>Host Count &amp; Block Size</h3>
        <div class="drill-desc">Given a prefix, calculate usable hosts and block size</div>
        <div class="streak-bar" id="hostStreak"></div>
        <div class="math-problem" id="hostProblem"></div>
        <div class="controls" style="margin-top:0;">
          <button class="btn btn-primary" id="hostCheck">Check</button>
          <button class="btn" id="hostShow">Show</button>
          <button class="btn" id="hostNext">Next</button>
          <div class="score-display" id="hostScore"></div>
        </div>
      </div>

      <!-- Wildcard mask drill -->
      <div class="math-drill-card">
        <h3>Wildcard Masks</h3>
        <div class="drill-desc">Convert subnet mask to wildcard mask (bitwise inverse)</div>
        <div class="streak-bar" id="wcStreak"></div>
        <div class="math-problem" id="wcProblem"></div>
        <div class="controls" style="margin-top:0;">
          <button class="btn btn-primary" id="wcCheck">Check</button>
          <button class="btn" id="wcShow">Show</button>
          <button class="btn" id="wcNext">Next</button>
          <div class="score-display" id="wcScore"></div>
        </div>
      </div>

      <!-- AND operation drill -->
      <div class="math-drill-card">
        <h3>Network Address (AND Operation)</h3>
        <div class="drill-desc">AND the IP with the mask to find the network address</div>
        <div class="streak-bar" id="andStreak"></div>
        <div class="math-problem" id="andProblem"></div>
        <div class="controls" style="margin-top:0;">
          <button class="btn btn-primary" id="andCheck">Check</button>
          <button class="btn" id="andShow">Show</button>
          <button class="btn" id="andNext">Next</button>
          <div class="score-display" id="andScore"></div>
        </div>
      </div>

      <!-- Binary AND visualizer -->
      <div class="math-drill-card">
        <h3>&#9654; Bitwise AND Visualizer</h3>
        <div class="drill-desc">See how IP AND Mask produces the network address, bit by bit</div>
        <div style="display:flex;gap:0.5rem;margin-bottom:0.75rem;flex-wrap:wrap;">
          <input type="text" id="andVizIp" placeholder="192.168.10.50" value="192.168.10.50" style="flex:1;padding:0.5rem;font-family:'JetBrains Mono',monospace;font-size:0.85rem;background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-primary);outline:none;min-width:140px;">
          <input type="text" id="andVizMask" placeholder="/24 or 255.255.255.0" value="/24" style="flex:1;padding:0.5rem;font-family:'JetBrains Mono',monospace;font-size:0.85rem;background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-primary);outline:none;min-width:140px;">
          <button class="btn btn-primary" id="andVizCalc">Visualize</button>
        </div>
        <div class="bitwise-viz" id="andViz"></div>
      </div>
    </section>

    <!-- ============ SUBNET CALCULATOR ============ -->
    <section id="subnet-calc" class="section">
      <div class="section-header">
        <h2>Subnet Calculator</h2>
        <p>Enter an IP address and CIDR prefix to calculate subnet details</p>
      </div>
      <div class="subnet-tool">
        <div class="subnet-panel">
          <h3>&#9654; Input</h3>
          <div class="input-group">
            <label>IP Address</label>
            <input type="text" id="subnetIp" placeholder="192.168.1.100" value="192.168.1.100">
          </div>
          <div class="input-group">
            <label>CIDR Prefix</label>
            <input type="number" id="subnetCidr" min="0" max="32" value="24" placeholder="/24">
          </div>
          <button class="btn btn-primary" id="subnetCalc" style="width:100%;margin-top:0.5rem;">Calculate</button>
          <div class="binary-display" id="binaryDisplay" style="display:none;"></div>
        </div>
        <div class="subnet-panel">
          <h3>&#9654; Results</h3>
          <div class="result-grid" id="subnetResults">
            <div class="result-item full-width">
              <div class="ri-label">Enter an IP and prefix to see results</div>
            </div>
          </div>
        </div>
      </div>

      <div class="subnet-panel" style="margin-top:2rem;">
        <h3>&#9654; CIDR Cheat Sheet</h3>
        <div class="cidr-grid" id="cidrGrid"></div>
      </div>
    </section>

    <!-- ============ SUBNET PRACTICE ============ -->
    <section id="subnet-practice" class="section">
      <div class="section-header">
        <h2>Subnetting Practice</h2>
        <p>Given a CIDR address, calculate the subnet details by hand</p>
      </div>
      <div class="subnet-tool">
        <div class="subnet-panel">
          <h3>&#9654; Problem</h3>
          <div class="practice-prompt">
            <div class="pp-label">Find the subnet details for:</div>
            <div class="pp-value" id="practiceAddress">--</div>
          </div>
          <div class="practice-fields">
            <div class="practice-field">
              <label>Network Addr</label>
              <input type="text" id="ansNetwork" placeholder="e.g. 10.0.0.0">
            </div>
            <div class="practice-field">
              <label>Broadcast</label>
              <input type="text" id="ansBroadcast" placeholder="e.g. 10.0.0.255">
            </div>
            <div class="practice-field">
              <label>Subnet Mask</label>
              <input type="text" id="ansMask" placeholder="e.g. 255.255.255.0">
            </div>
            <div class="practice-field">
              <label>Usable Hosts</label>
              <input type="number" id="ansHosts" placeholder="e.g. 254">
            </div>
            <div class="practice-field">
              <label>First Usable</label>
              <input type="text" id="ansFirst" placeholder="e.g. 10.0.0.1">
            </div>
            <div class="practice-field">
              <label>Last Usable</label>
              <input type="text" id="ansLast" placeholder="e.g. 10.0.0.254">
            </div>
          </div>
          <div class="controls" style="margin-top:0;">
            <button class="btn btn-primary" id="practiceCheck">Check</button>
            <button class="btn" id="practiceShow">Show Answer</button>
            <button class="btn" id="practiceNew">New Problem</button>
          </div>
          <div class="practice-feedback" id="practiceFeedback"></div>
        </div>
        <div class="subnet-panel">
          <h3>&#9654; Tips</h3>
          <div style="font-size:0.85rem;color:var(--text-secondary);line-height:1.7;">
            <p style="margin-bottom:0.75rem;"><strong style="color:var(--accent-cyan);">Step 1:</strong> Convert the prefix to a subnet mask. Each octet gets 8 bits. /24 = 255.255.255.0</p>
            <p style="margin-bottom:0.75rem;"><strong style="color:var(--accent-cyan);">Step 2:</strong> AND the IP with the mask to find the network address.</p>
            <p style="margin-bottom:0.75rem;"><strong style="color:var(--accent-cyan);">Step 3:</strong> Invert the mask (wildcard) and OR with network address for broadcast.</p>
            <p style="margin-bottom:0.75rem;"><strong style="color:var(--accent-cyan);">Step 4:</strong> Usable hosts = 2^(32 - prefix) - 2 (for /31 and /32, special rules apply).</p>
            <p><strong style="color:var(--accent-cyan);">Step 5:</strong> First usable = network + 1, last usable = broadcast - 1.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- ============ REFERENCE TABLE ============ -->
    <section id="reference" class="section">
      <div class="section-header">
        <h2>Quick Reference</h2>
        <p>Common protocols, ports, and their OSI layers</p>
      </div>
      <div class="subnet-panel">
        <div class="ref-table-wrapper">
          <table class="ref-table" id="refTable">
            <thead>
              <tr>
                <th>Protocol</th>
                <th>Port(s)</th>
                <th>Layer</th>
                <th>Transport</th>
                <th>Description</th>
              </tr>
            </thead>
            <tbody id="refBody"></tbody>
          </table>
        </div>
      </div>
    </section>

  </main>
</div>

<script>
// =====================================================================
// DATA DEFINITIONS
// =====================================================================

const OSI_LAYERS = [
  { num: 7, name: 'Application',  color: 'var(--layer-7)', addressing: 'Data',        pdu: 'Messages' },
  { num: 6, name: 'Presentation', color: 'var(--layer-6)', addressing: 'Data',        pdu: 'Encoding' },
  { num: 5, name: 'Session',      color: 'var(--layer-5)', addressing: 'Data',        pdu: 'Sessions' },
  { num: 4, name: 'Transport',    color: 'var(--layer-4)', addressing: 'Port Numbers', pdu: 'Segments' },
  { num: 3, name: 'Network',      color: 'var(--layer-3)', addressing: 'IP Address',   pdu: 'Packets' },
  { num: 2, name: 'Data Link',    color: 'var(--layer-2)', addressing: 'MAC Address',  pdu: 'Frames' },
  { num: 1, name: 'Physical',     color: 'var(--layer-1)', addressing: 'Signals',      pdu: 'Bits' },
];

const LAYER_BY_NUM = Object.fromEntries(OSI_LAYERS.map(l => [l.num, l]));

const PROTOCOLS = [
  { name: 'HTTP',    port: '80',     layer: 7, transport: 'TCP', desc: 'Hypertext Transfer Protocol' },
  { name: 'HTTPS',   port: '443',    layer: 7, transport: 'TCP', desc: 'HTTP over TLS' },
  { name: 'FTP',     port: '20/21',  layer: 7, transport: 'TCP', desc: 'File Transfer Protocol' },
  { name: 'SSH',     port: '22',     layer: 7, transport: 'TCP', desc: 'Secure Shell' },
  { name: 'Telnet',  port: '23',     layer: 7, transport: 'TCP', desc: 'Remote terminal (unencrypted)' },
  { name: 'SMTP',    port: '25',     layer: 7, transport: 'TCP', desc: 'Simple Mail Transfer Protocol' },
  { name: 'DNS',     port: '53',     layer: 7, transport: 'TCP/UDP', desc: 'Domain Name System' },
  { name: 'DHCP',    port: '67/68',  layer: 7, transport: 'UDP', desc: 'Dynamic Host Configuration' },
  { name: 'TFTP',    port: '69',     layer: 7, transport: 'UDP', desc: 'Trivial File Transfer Protocol' },
  { name: 'SNMP',    port: '161',    layer: 7, transport: 'UDP', desc: 'Simple Network Mgmt Protocol' },
  { name: 'IMAP',    port: '143',    layer: 7, transport: 'TCP', desc: 'Internet Message Access Protocol' },
  { name: 'POP3',    port: '110',    layer: 7, transport: 'TCP', desc: 'Post Office Protocol v3' },
  { name: 'RDP',     port: '3389',   layer: 7, transport: 'TCP/UDP', desc: 'Remote Desktop Protocol' },
  { name: 'NTP',     port: '123',    layer: 7, transport: 'UDP', desc: 'Network Time Protocol' },
  { name: 'TLS/SSL', port: '--',     layer: 6, transport: '--', desc: 'Encryption & session security' },
  { name: 'JPEG',    port: '--',     layer: 6, transport: '--', desc: 'Image encoding format' },
  { name: 'ASCII',   port: '--',     layer: 6, transport: '--', desc: 'Text encoding' },
  { name: 'NetBIOS', port: '137-139',layer: 5, transport: 'TCP/UDP', desc: 'Session management (legacy)' },
  { name: 'PPTP',    port: '1723',   layer: 5, transport: 'TCP', desc: 'Point-to-Point Tunneling' },
  { name: 'TCP',     port: '--',     layer: 4, transport: '--', desc: 'Transmission Control Protocol' },
  { name: 'UDP',     port: '--',     layer: 4, transport: '--', desc: 'User Datagram Protocol' },
  { name: 'IP',      port: '--',     layer: 3, transport: '--', desc: 'Internet Protocol' },
  { name: 'ICMP',    port: '--',     layer: 3, transport: '--', desc: 'Internet Control Message Protocol' },
  { name: 'ARP',     port: '--',     layer: 3, transport: '--', desc: 'Address Resolution Protocol' },
  { name: 'OSPF',    port: '--',     layer: 3, transport: '--', desc: 'Open Shortest Path First' },
  { name: 'BGP',     port: '179',    layer: 3, transport: 'TCP', desc: 'Border Gateway Protocol' },
  { name: 'Ethernet',port: '--',     layer: 2, transport: '--', desc: 'LAN frame protocol' },
  { name: 'Wi-Fi',   port: '--',     layer: 2, transport: '--', desc: '802.11 wireless LAN' },
  { name: 'PPP',     port: '--',     layer: 2, transport: '--', desc: 'Point-to-Point Protocol' },
  { name: 'MAC',     port: '--',     layer: 2, transport: '--', desc: 'Media Access Control addressing' },
  { name: 'Fiber',   port: '--',     layer: 1, transport: '--', desc: 'Fiber optic cabling' },
  { name: 'DSL',     port: '--',     layer: 1, transport: '--', desc: 'Digital Subscriber Line' },
  { name: 'USB',     port: '--',     layer: 1, transport: '--', desc: 'Universal Serial Bus' },
  { name: 'Bluetooth',port:'--',     layer: 1, transport: '--', desc: 'Short-range wireless' },
];

const QUIZ_GENERATORS = [
  {
    id: 'which-layer',
    make: (proto) => ({
      prompt: `Which OSI layer does ${proto.name} operate at?`,
      hint: proto.desc,
      options: OSI_LAYERS.map(l => `L${l.num} ${l.name}`),
      correctIdx: OSI_LAYERS.findIndex(l => l.num === proto.layer),
      explanation: `${proto.name} operates at Layer ${proto.layer} (${LAYER_BY_NUM[proto.layer].name}). ${proto.desc}.`,
    }),
  },
  {
    id: 'which-port',
    filter: (p) => p.port !== '--',
    make: (proto) => {
      const wrong = PROTOCOLS.filter(p => p.port !== '--' && p.name !== proto.name).sort(() => Math.random() - 0.5).slice(0, 3).map(p => p.port);
      const options = [...wrong, proto.port].sort(() => Math.random() - 0.5);
      return {
        prompt: `What port does ${proto.name} use?`,
        hint: proto.desc,
        options,
        correctIdx: options.indexOf(proto.port),
        explanation: `${proto.name} uses port ${proto.port}. ${proto.desc}.`,
      };
    },
  },
  {
    id: 'tcp-or-udp',
    filter: (p) => ['TCP', 'UDP'].includes(p.transport),
    make: (proto) => ({
      prompt: `Does ${proto.name} use TCP or UDP?`,
      hint: `Port ${proto.port}`,
      options: ['TCP', 'UDP', 'Both'],
      correctIdx: ['TCP', 'UDP', 'Both'].indexOf(proto.transport),
      explanation: `${proto.name} (port ${proto.port}) uses ${proto.transport}. ${proto.desc}.`,
    }),
  },
  {
    id: 'which-addressing',
    make: (proto) => {
      const layer = LAYER_BY_NUM[proto.layer];
      const options = ['Data', 'Port Numbers', 'IP Address', 'MAC Address', 'Signals'];
      return {
        prompt: `What addressing/PDU type is used at ${proto.name}'s layer?`,
        hint: `${proto.name} operates at Layer ${proto.layer}`,
        options,
        correctIdx: options.indexOf(layer.addressing),
        explanation: `Layer ${proto.layer} (${layer.name}) uses ${layer.addressing} addressing and ${layer.pdu} as its PDU.`,
      };
    },
  },
];

const QUESTION_COUNT = 6;

const CIDR_ENTRIES = Array.from({ length: 25 }, (_, i) => {
  const prefix = 8 + i;
  const hostBits = 32 - prefix;
  const totalAddresses = Math.pow(2, hostBits);
  const usableHosts = hostBits > 1 ? totalAddresses - 2 : (hostBits === 1 ? 2 : 1);
  return { prefix, totalAddresses, usableHosts };
});

const PRACTICE_PREFIXES = [8, 12, 16, 18, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30];

// =====================================================================
// UTILITIES
// =====================================================================

const $ = (sel) => document.querySelector(sel);
const $$ = (sel) => [...document.querySelectorAll(sel)];

function shuffle(arr) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function ipToInt(ip) {
  return ip.split('.').reduce((acc, oct) => (acc << 8) + parseInt(oct, 10), 0) >>> 0;
}

function intToIp(n) {
  return [n >>> 24, (n >>> 16) & 0xff, (n >>> 8) & 0xff, n & 0xff].join('.');
}

function cidrToMask(prefix) {
  return prefix === 0 ? 0 : (0xffffffff << (32 - prefix)) >>> 0;
}

function intToBinary(n) {
  return Array.from({ length: 4 }, (_, i) => ((n >>> (24 - i * 8)) & 0xff).toString(2).padStart(8, '0'));
}

function calcSubnet(ipStr, prefix) {
  const ip = ipToInt(ipStr);
  const mask = cidrToMask(prefix);
  const network = (ip & mask) >>> 0;
  const broadcast = (network | ~mask) >>> 0;
  const hostBits = 32 - prefix;
  const totalAddresses = Math.pow(2, hostBits);
  const usableHosts = hostBits > 1 ? totalAddresses - 2 : (hostBits === 1 ? 2 : 1);
  const firstUsable = hostBits > 1 ? network + 1 : network;
  const lastUsable = hostBits > 1 ? broadcast - 1 : broadcast;
  return {
    network: intToIp(network), broadcast: intToIp(broadcast),
    mask: intToIp(mask), wildcard: intToIp(~mask >>> 0),
    usableHosts, totalAddresses,
    firstUsable: intToIp(firstUsable), lastUsable: intToIp(lastUsable),
    prefix, ipBinary: intToBinary(ip), maskBinary: intToBinary(mask),
  };
}

function randomIp() {
  const first = [10, 172, 192][Math.floor(Math.random() * 3)];
  const gen = () => Math.floor(Math.random() * 256);
  if (first === 10) return `10.${gen()}.${gen()}.${gen()}`;
  if (first === 172) return `172.${16 + Math.floor(Math.random() * 16)}.${gen()}.${gen()}`;
  return `192.168.${gen()}.${gen()}`;
}

function renderStreakBar(containerId, history) {
  const el = document.getElementById(containerId);
  if (!el) return;
  const last10 = history.slice(-10);
  const total = history.length;
  const correct = history.filter(h => h).length;
  el.innerHTML = `
    <span class="streak-label">Score:</span>
    <span class="streak-count">${correct}/${total}</span>
    <div class="streak-dots">${last10.map(h => `<div class="streak-dot ${h ? 'correct' : 'wrong'}"></div>`).join('')}</div>
  `;
}

// =====================================================================
// TAB NAVIGATION
// =====================================================================

$$('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    $$('.tab-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    $$('.section').forEach(s => s.classList.remove('active'));
    $(`#${btn.dataset.tab}`).classList.add('active');
  });
});

// =====================================================================
// OSI DRAG & DROP (enhanced: click-to-remove + addressing)
// =====================================================================

let placedLayers = {};

function renderOsiGame() {
  placedLayers = {};
  const stack = $('#layerStack');
  const pool = $('#dragItems');
  $('#osiScore').textContent = '';

  stack.innerHTML = OSI_LAYERS.map(l => `
    <div class="layer-slot" data-layer="${l.num}"
         ondragover="event.preventDefault(); this.classList.add('drag-over')"
         ondragleave="this.classList.remove('drag-over')"
         ondrop="handleDrop(event, ${l.num})">
      <div class="layer-num" style="background:${l.color}">L${l.num}</div>
      <span class="layer-slot-label">Drop layer name here</span>
      <div class="layer-addressing">
        <span class="addr-type">${l.addressing}</span><br>
        <span class="addr-pdu">${l.pdu}</span>
      </div>
    </div>
  `).join('');

  const shuffled = shuffle(OSI_LAYERS);
  pool.innerHTML = shuffled.map(l => `
    <div class="drag-item" draggable="true" data-name="${l.name}"
         ondragstart="event.dataTransfer.setData('text/plain','${l.name}')">${l.name}</div>
  `).join('');
}

window.handleDrop = function(e, slotNum) {
  e.preventDefault();
  const slot = e.currentTarget;
  slot.classList.remove('drag-over');
  const name = e.dataTransfer.getData('text/plain');

  // Remove from previous slot if placed elsewhere
  Object.entries(placedLayers).forEach(([num, val]) => {
    if (val === name) {
      delete placedLayers[num];
      const prevSlot = $(`.layer-slot[data-layer="${num}"]`);
      prevSlot.querySelector('.placed-item')?.remove();
      const label = prevSlot.querySelector('.layer-slot-label');
      if (label) label.style.display = '';
    }
  });

  // Remove existing item in this slot
  if (placedLayers[slotNum]) {
    const oldName = placedLayers[slotNum];
    slot.querySelector('.placed-item')?.remove();
    const oldChip = $(`.drag-item[data-name="${oldName}"]`);
    if (oldChip) oldChip.classList.remove('placed');
  }

  placedLayers[slotNum] = name;
  const label = slot.querySelector('.layer-slot-label');
  if (label) label.style.display = 'none';

  const el = document.createElement('span');
  el.className = 'placed-item';
  el.innerHTML = `${name} <span class="remove-x">&#10005;</span>`;
  el.addEventListener('click', () => removePlaced(slotNum));
  slot.appendChild(el);

  const chip = $(`.drag-item[data-name="${name}"]`);
  if (chip) chip.classList.add('placed');

  slot.classList.remove('correct', 'incorrect');
};

function removePlaced(slotNum) {
  const slot = $(`.layer-slot[data-layer="${slotNum}"]`);
  if (!slot || !placedLayers[slotNum]) return;

  const name = placedLayers[slotNum];
  delete placedLayers[slotNum];

  slot.querySelector('.placed-item')?.remove();
  const label = slot.querySelector('.layer-slot-label');
  if (label) label.style.display = '';
  slot.classList.remove('correct', 'incorrect');

  const chip = $(`.drag-item[data-name="${name}"]`);
  if (chip) chip.classList.remove('placed');
}

$('#osiCheck').addEventListener('click', () => {
  let correct = 0;
  OSI_LAYERS.forEach(l => {
    const slot = $(`.layer-slot[data-layer="${l.num}"]`);
    slot.classList.remove('correct', 'incorrect');
    if (placedLayers[l.num] === l.name) {
      slot.classList.add('correct');
      correct++;
    } else if (placedLayers[l.num]) {
      slot.classList.add('incorrect');
    }
  });
  $('#osiScore').textContent = `${correct} / ${OSI_LAYERS.length} correct`;
});

$('#osiReset').addEventListener('click', renderOsiGame);

// =====================================================================
// PROTOCOL QUIZ
// =====================================================================

function generateQuestions() {
  const questions = [];
  let attempts = 0;
  while (questions.length < QUESTION_COUNT && attempts < 100) {
    attempts++;
    const gen = QUIZ_GENERATORS[Math.floor(Math.random() * QUIZ_GENERATORS.length)];
    const candidates = PROTOCOLS.filter(gen.filter || (() => true));
    const proto = candidates[Math.floor(Math.random() * candidates.length)];
    const key = `${gen.id}-${proto.name}`;
    if (questions.some(q => q.key === key)) continue;
    const q = gen.make(proto);
    q.key = key;
    questions.push(q);
  }
  return questions;
}

let quizQuestions = [];
let quizAnswered = 0;
let quizCorrect = 0;

function renderProtocolQuiz() {
  quizQuestions = generateQuestions();
  quizAnswered = 0;
  quizCorrect = 0;
  $('#protoScore').textContent = '';

  $('#protocolGame').innerHTML = quizQuestions.map((q, qi) => `
    <div class="protocol-question" id="pq-${qi}">
      <div class="pq-prompt">${q.prompt}</div>
      <div class="pq-hint">${q.hint}</div>
      <div class="pq-options">
        ${q.options.map((opt, oi) => `
          <button class="pq-option" data-qi="${qi}" data-oi="${oi}" onclick="handleQuizAnswer(${qi},${oi})">${opt}</button>
        `).join('')}
      </div>
      <div class="pq-explanation" id="pqe-${qi}">${q.explanation}</div>
    </div>
  `).join('');
}

window.handleQuizAnswer = function(qi, oi) {
  const q = quizQuestions[qi];
  const container = $(`#pq-${qi}`);
  const buttons = container.querySelectorAll('.pq-option');
  const isCorrect = oi === q.correctIdx;

  quizAnswered++;
  if (isCorrect) quizCorrect++;

  buttons.forEach((btn, i) => {
    btn.classList.add('disabled');
    if (i === q.correctIdx) btn.classList.add(i === oi ? 'selected-correct' : 'show-correct');
    if (i === oi && !isCorrect) btn.classList.add('selected-wrong');
  });

  container.classList.add(isCorrect ? 'answered-correct' : 'answered-wrong');
  $(`#pqe-${qi}`).classList.add('visible');
  $('#protoScore').textContent = `${quizCorrect} / ${quizAnswered} correct`;
};

$('#protoNew').addEventListener('click', renderProtocolQuiz);

// =====================================================================
// NUMBER SYSTEMS
// =====================================================================

// Live converter
function updateFromDec(val) {
  val = Math.max(0, Math.min(255, parseInt(val, 10) || 0));
  $('#convDec').value = val;
  $('#convBin').value = val.toString(2).padStart(8, '0');
  $('#convHex').value = val.toString(16).toUpperCase().padStart(2, '0');
  updateBitChart(val);
}

function updateFromBin(val) {
  val = val.replace(/[^01]/g, '').slice(0, 8);
  const dec = parseInt(val || '0', 2);
  $('#convBin').value = val.padStart(8, '0');
  $('#convDec').value = dec;
  $('#convHex').value = dec.toString(16).toUpperCase().padStart(2, '0');
  updateBitChart(dec);
}

function updateFromHex(val) {
  val = val.replace(/[^0-9a-fA-F]/g, '').slice(0, 2);
  const dec = parseInt(val || '0', 16);
  $('#convHex').value = val.toUpperCase();
  $('#convDec').value = dec;
  $('#convBin').value = dec.toString(2).padStart(8, '0');
  updateBitChart(dec);
}

$('#convDec').addEventListener('input', (e) => updateFromDec(e.target.value));
$('#convBin').addEventListener('input', (e) => updateFromBin(e.target.value));
$('#convHex').addEventListener('input', (e) => updateFromHex(e.target.value));

// Bit toggle chart
const bitValues = [128, 64, 32, 16, 8, 4, 2, 1];
let activeBits = [0, 0, 0, 0, 0, 0, 0, 0];

function renderBitChart() {
  const chart = $('#bitChart');
  chart.innerHTML =
    bitValues.map(v => `<div class="bit-cell header">${v}</div>`).join('') +
    activeBits.map((b, i) => `<div class="bit-cell value ${b ? 'active' : ''}" data-idx="${i}">${b}</div>`).join('');

  chart.querySelectorAll('.bit-cell.value').forEach(cell => {
    cell.addEventListener('click', () => {
      const idx = parseInt(cell.dataset.idx);
      activeBits[idx] = activeBits[idx] ? 0 : 1;
      renderBitChart();
      const total = activeBits.reduce((sum, b, i) => sum + b * bitValues[i], 0);
      updateFromDec(total);
    });
  });

  const total = activeBits.reduce((sum, b, i) => sum + b * bitValues[i], 0);
  $('#bitTotal').textContent = `= ${total}`;
}

function updateBitChart(dec) {
  for (let i = 0; i < 8; i++) {
    activeBits[i] = (dec >> (7 - i)) & 1;
  }
  renderBitChart();
}

// Hex reference chart
$('#hexChart').innerHTML = Array.from({ length: 16 }, (_, i) => `
  <div class="hex-cell">
    <span class="hc-dec">${i}</span>
    <span class="hc-hex">0x${i.toString(16).toUpperCase()}</span>
    <span class="hc-bin">${i.toString(2).padStart(4, '0')}</span>
  </div>
`).join('');

// Powers of 2 chart
$('#powersChart').innerHTML = Array.from({ length: 17 }, (_, i) => `
  <div class="power-cell">
    <div class="exp">2^${i}</div>
    <div class="val">${Math.pow(2, i).toLocaleString()}</div>
  </div>
`).join('');

// Number drill
let numDrillAnswer = {};
let numDrillHistory = [];
let numDrillCorrectCount = 0;
let numDrillTotal = 0;

function newNumDrill() {
  const bases = ['DEC', 'BIN', 'HEX'];
  const fromBase = bases[Math.floor(Math.random() * bases.length)];
  const dec = Math.floor(Math.random() * 256);
  const bin = dec.toString(2).padStart(8, '0');
  const hex = dec.toString(16).toUpperCase().padStart(2, '0');

  let displayValue, targetBases;
  if (fromBase === 'DEC') {
    displayValue = String(dec);
    targetBases = [{ label: 'BIN', answer: bin }, { label: 'HEX', answer: hex }];
  } else if (fromBase === 'BIN') {
    displayValue = bin;
    targetBases = [{ label: 'DEC', answer: String(dec) }, { label: 'HEX', answer: hex }];
  } else {
    displayValue = '0x' + hex;
    targetBases = [{ label: 'DEC', answer: String(dec) }, { label: 'BIN', answer: bin }];
  }

  numDrillAnswer = { fromBase, displayValue, targets: targetBases };
  $('#numDrillBase').textContent = `Convert from ${fromBase}`;
  $('#numDrillValue').textContent = displayValue;

  $('#numDrillInputs').innerHTML = targetBases.map((t, i) => `
    <div class="drill-input-row">
      <label>${t.label}</label>
      <input type="text" id="numDrillIn${i}" placeholder="?">
    </div>
  `).join('');

  // Enter key support
  const inputs = $('#numDrillInputs').querySelectorAll('input');
  inputs.forEach(inp => {
    inp.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') checkNumDrill();
    });
  });
  if (inputs[0]) inputs[0].focus();
}

function checkNumDrill() {
  let allCorrect = true;
  numDrillAnswer.targets.forEach((t, i) => {
    const inp = $(`#numDrillIn${i}`);
    const userVal = inp.value.trim().toUpperCase().replace(/^0X/, '');
    const answer = t.answer.toUpperCase();
    const isCorrect = userVal === answer;
    inp.classList.remove('correct-input', 'incorrect-input');
    inp.classList.add(isCorrect ? 'correct-input' : 'incorrect-input');
    if (!isCorrect) allCorrect = false;
  });

  numDrillTotal++;
  if (allCorrect) numDrillCorrectCount++;
  numDrillHistory.push(allCorrect);
  $('#numDrillScore').textContent = `${numDrillCorrectCount}/${numDrillTotal}`;
  renderStreakBar('numDrillStreak', numDrillHistory);
}

function showNumDrill() {
  numDrillAnswer.targets.forEach((t, i) => {
    const inp = $(`#numDrillIn${i}`);
    inp.value = t.answer;
    inp.classList.remove('incorrect-input');
    inp.classList.add('correct-input');
  });
}

$('#numDrillCheck').addEventListener('click', checkNumDrill);
$('#numDrillShow').addEventListener('click', showNumDrill);
$('#numDrillNext').addEventListener('click', newNumDrill);

// =====================================================================
// SUBNET MATH DRILLS
// =====================================================================

// --- CIDR <-> Mask Drill ---
let cidrDrillData = {};
let cidrHistory = [];

function newCidrDrill() {
  const direction = Math.random() < 0.5 ? 'toMask' : 'toCidr';
  const prefix = Math.floor(Math.random() * 25) + 8; // /8 to /32
  const mask = intToIp(cidrToMask(prefix));

  if (direction === 'toMask') {
    cidrDrillData = { question: `What is the subnet mask for /${prefix}?`, answer: mask, direction };
    $('#cidrProblem').innerHTML = `
      <div class="mp-question">What is the subnet mask for <strong style="color:var(--accent-cyan)">/${prefix}</strong> ?</div>
      <div class="mp-input-row">
        <input type="text" id="cidrAnswer" placeholder="e.g. 255.255.255.0">
      </div>
      <div class="mp-feedback" id="cidrFeedback"></div>
    `;
  } else {
    cidrDrillData = { question: `What CIDR prefix is ${mask}?`, answer: `/${prefix}`, answerNum: prefix, direction };
    $('#cidrProblem').innerHTML = `
      <div class="mp-question">What CIDR prefix equals <strong style="color:var(--accent-cyan)">${mask}</strong> ?</div>
      <div class="mp-input-row">
        <input type="text" id="cidrAnswer" placeholder="e.g. /24 or 24">
      </div>
      <div class="mp-feedback" id="cidrFeedback"></div>
    `;
  }

  $('#cidrAnswer').addEventListener('keydown', (e) => { if (e.key === 'Enter') checkCidrDrill(); });
  $('#cidrAnswer').focus();
}

function checkCidrDrill() {
  const inp = $('#cidrAnswer');
  const fb = $('#cidrFeedback');
  let userVal = inp.value.trim();
  let isCorrect;

  if (cidrDrillData.direction === 'toMask') {
    isCorrect = userVal === cidrDrillData.answer;
  } else {
    userVal = userVal.replace('/', '');
    isCorrect = parseInt(userVal) === cidrDrillData.answerNum;
  }

  inp.classList.remove('correct-input', 'incorrect-input');
  inp.classList.add(isCorrect ? 'correct-input' : 'incorrect-input');
  fb.className = 'mp-feedback visible ' + (isCorrect ? 'correct' : 'wrong');
  fb.textContent = isCorrect ? 'Correct!' : `Answer: ${cidrDrillData.answer}`;
  cidrHistory.push(isCorrect);
  renderStreakBar('cidrStreak', cidrHistory);
  $('#cidrScore').textContent = `${cidrHistory.filter(h=>h).length}/${cidrHistory.length}`;
}

$('#cidrCheck').addEventListener('click', checkCidrDrill);
$('#cidrShow').addEventListener('click', () => {
  $('#cidrAnswer').value = cidrDrillData.answer;
  $('#cidrAnswer').classList.add('correct-input');
  const fb = $('#cidrFeedback');
  fb.className = 'mp-feedback visible correct';
  fb.textContent = cidrDrillData.answer;
});
$('#cidrNext').addEventListener('click', newCidrDrill);

// --- Hosts & Block Size Drill ---
let hostDrillData = {};
let hostHistory = [];

function newHostDrill() {
  const prefix = Math.floor(Math.random() * 25) + 8;
  const hostBits = 32 - prefix;
  const totalAddresses = Math.pow(2, hostBits);
  const usableHosts = hostBits > 1 ? totalAddresses - 2 : (hostBits === 1 ? 2 : 1);
  const blockSize = totalAddresses;

  hostDrillData = { prefix, usableHosts, blockSize };

  $('#hostProblem').innerHTML = `
    <div class="mp-question">For <strong style="color:var(--accent-cyan)">/${prefix}</strong>  how many <strong>usable hosts</strong> and what is the <strong>block size</strong>?</div>
    <div class="mp-input-row" style="margin-bottom:0.5rem;">
      <input type="text" id="hostAnswerHosts" placeholder="Usable hosts" style="flex:1;">
      <input type="text" id="hostAnswerBlock" placeholder="Block size" style="flex:1;">
    </div>
    <div class="mp-feedback" id="hostFeedback"></div>
  `;

  $('#hostProblem').querySelectorAll('input').forEach(inp => {
    inp.addEventListener('keydown', (e) => { if (e.key === 'Enter') checkHostDrill(); });
  });
  $('#hostAnswerHosts').focus();
}

function checkHostDrill() {
  const hostsInp = $('#hostAnswerHosts');
  const blockInp = $('#hostAnswerBlock');
  const fb = $('#hostFeedback');

  const hostsCorrect = parseInt(hostsInp.value) === hostDrillData.usableHosts;
  const blockCorrect = parseInt(blockInp.value) === hostDrillData.blockSize;

  hostsInp.classList.remove('correct-input', 'incorrect-input');
  blockInp.classList.remove('correct-input', 'incorrect-input');
  hostsInp.classList.add(hostsCorrect ? 'correct-input' : 'incorrect-input');
  blockInp.classList.add(blockCorrect ? 'correct-input' : 'incorrect-input');

  const allCorrect = hostsCorrect && blockCorrect;
  fb.className = 'mp-feedback visible ' + (allCorrect ? 'correct' : 'wrong');
  fb.textContent = allCorrect ? 'Correct!' : `Hosts: ${hostDrillData.usableHosts}, Block size: ${hostDrillData.blockSize} (2^${32-hostDrillData.prefix})`;
  hostHistory.push(allCorrect);
  renderStreakBar('hostStreak', hostHistory);
  $('#hostScore').textContent = `${hostHistory.filter(h=>h).length}/${hostHistory.length}`;
}

$('#hostCheck').addEventListener('click', checkHostDrill);
$('#hostShow').addEventListener('click', () => {
  $('#hostAnswerHosts').value = hostDrillData.usableHosts;
  $('#hostAnswerBlock').value = hostDrillData.blockSize;
  $('#hostAnswerHosts').classList.add('correct-input');
  $('#hostAnswerBlock').classList.add('correct-input');
  const fb = $('#hostFeedback');
  fb.className = 'mp-feedback visible correct';
  fb.textContent = `Hosts: ${hostDrillData.usableHosts}, Block size: ${hostDrillData.blockSize}`;
});
$('#hostNext').addEventListener('click', newHostDrill);

// --- Wildcard Mask Drill ---
let wcDrillData = {};
let wcHistory = [];

function newWcDrill() {
  const prefix = Math.floor(Math.random() * 25) + 8;
  const mask = cidrToMask(prefix);
  const wildcard = (~mask >>> 0);
  const direction = Math.random() < 0.5 ? 'toWildcard' : 'toMask';

  if (direction === 'toWildcard') {
    wcDrillData = { question: intToIp(mask), answer: intToIp(wildcard), direction };
    $('#wcProblem').innerHTML = `
      <div class="mp-question">Wildcard mask for subnet <strong style="color:var(--accent-cyan)">${intToIp(mask)}</strong> ?</div>
      <div class="mp-input-row"><input type="text" id="wcAnswer" placeholder="e.g. 0.0.0.255"></div>
      <div class="mp-feedback" id="wcFeedback"></div>
    `;
  } else {
    wcDrillData = { question: intToIp(wildcard), answer: intToIp(mask), direction };
    $('#wcProblem').innerHTML = `
      <div class="mp-question">Subnet mask for wildcard <strong style="color:var(--accent-cyan)">${intToIp(wildcard)}</strong> ?</div>
      <div class="mp-input-row"><input type="text" id="wcAnswer" placeholder="e.g. 255.255.255.0"></div>
      <div class="mp-feedback" id="wcFeedback"></div>
    `;
  }

  $('#wcAnswer').addEventListener('keydown', (e) => { if (e.key === 'Enter') checkWcDrill(); });
  $('#wcAnswer').focus();
}

function checkWcDrill() {
  const inp = $('#wcAnswer');
  const fb = $('#wcFeedback');
  const isCorrect = inp.value.trim() === wcDrillData.answer;
  inp.classList.remove('correct-input', 'incorrect-input');
  inp.classList.add(isCorrect ? 'correct-input' : 'incorrect-input');
  fb.className = 'mp-feedback visible ' + (isCorrect ? 'correct' : 'wrong');
  fb.textContent = isCorrect ? 'Correct!' : `Answer: ${wcDrillData.answer}`;
  wcHistory.push(isCorrect);
  renderStreakBar('wcStreak', wcHistory);
  $('#wcScore').textContent = `${wcHistory.filter(h=>h).length}/${wcHistory.length}`;
}

$('#wcCheck').addEventListener('click', checkWcDrill);
$('#wcShow').addEventListener('click', () => {
  $('#wcAnswer').value = wcDrillData.answer;
  $('#wcAnswer').classList.add('correct-input');
  const fb = $('#wcFeedback');
  fb.className = 'mp-feedback visible correct';
  fb.textContent = wcDrillData.answer;
});
$('#wcNext').addEventListener('click', newWcDrill);

// --- AND Operation Drill ---
let andDrillData = {};
let andHistory = [];

function newAndDrill() {
  const ip = randomIp();
  const prefix = PRACTICE_PREFIXES[Math.floor(Math.random() * PRACTICE_PREFIXES.length)];
  const mask = intToIp(cidrToMask(prefix));
  const network = intToIp((ipToInt(ip) & cidrToMask(prefix)) >>> 0);

  andDrillData = { ip, prefix, mask, answer: network };

  $('#andProblem').innerHTML = `
    <div class="mp-question">
      <strong style="color:var(--accent-cyan)">${ip}</strong> AND <strong style="color:var(--accent-amber)">${mask}</strong> = ?
    </div>
    <div class="mp-input-row"><input type="text" id="andAnswer" placeholder="Network address"></div>
    <div class="mp-feedback" id="andFeedback"></div>
  `;

  $('#andAnswer').addEventListener('keydown', (e) => { if (e.key === 'Enter') checkAndDrill(); });
  $('#andAnswer').focus();
}

function checkAndDrill() {
  const inp = $('#andAnswer');
  const fb = $('#andFeedback');
  const isCorrect = inp.value.trim() === andDrillData.answer;
  inp.classList.remove('correct-input', 'incorrect-input');
  inp.classList.add(isCorrect ? 'correct-input' : 'incorrect-input');
  fb.className = 'mp-feedback visible ' + (isCorrect ? 'correct' : 'wrong');
  fb.textContent = isCorrect ? 'Correct!' : `Answer: ${andDrillData.answer}`;
  andHistory.push(isCorrect);
  renderStreakBar('andStreak', andHistory);
  $('#andScore').textContent = `${andHistory.filter(h=>h).length}/${andHistory.length}`;
}

$('#andCheck').addEventListener('click', checkAndDrill);
$('#andShow').addEventListener('click', () => {
  $('#andAnswer').value = andDrillData.answer;
  $('#andAnswer').classList.add('correct-input');
  const fb = $('#andFeedback');
  fb.className = 'mp-feedback visible correct';
  fb.textContent = andDrillData.answer;
});
$('#andNext').addEventListener('click', newAndDrill);

// --- Bitwise AND Visualizer ---
$('#andVizCalc').addEventListener('click', () => {
  const ipStr = $('#andVizIp').value.trim();
  let maskInput = $('#andVizMask').value.trim();
  let maskInt;

  if (maskInput.startsWith('/')) {
    maskInt = cidrToMask(parseInt(maskInput.slice(1)));
  } else if (/^\d+$/.test(maskInput)) {
    maskInt = cidrToMask(parseInt(maskInput));
  } else {
    maskInt = ipToInt(maskInput);
  }

  if (!/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/.test(ipStr)) return;

  const ipInt = ipToInt(ipStr);
  const netInt = (ipInt & maskInt) >>> 0;
  const ipBits = intToBinary(ipInt).join('');
  const maskBits = intToBinary(maskInt).join('');
  const netBits = intToBinary(netInt).join('');

  function renderRow(label, bits, maskBitsRef) {
    let html = `<div class="bitwise-row"><span class="bw-label">${label}</span><div class="bw-bits">`;
    for (let i = 0; i < 32; i++) {
      if (i > 0 && i % 8 === 0) html += `<div class="bw-bit sep">.</div>`;
      const isNet = maskBitsRef ? maskBitsRef[i] === '1' : true;
      html += `<div class="bw-bit ${bits[i] === '1' ? 'one' : 'zero'}">${bits[i]}</div>`;
    }
    html += `</div></div>`;
    return html;
  }

  $('#andViz').innerHTML =
    renderRow(`IP`, ipBits, maskBits) +
    renderRow(`Mask`, maskBits, null) +
    `<div style="border-top:1px solid var(--border);margin:0.4rem 0;"></div>` +
    renderRow(`Net`, netBits, maskBits) +
    `<div style="margin-top:0.5rem;font-size:0.78rem;color:var(--text-muted);">
      ${ipStr} AND ${intToIp(maskInt)} = <strong style="color:var(--accent-green)">${intToIp(netInt)}</strong>
    </div>`;
});

// =====================================================================
// SUBNET CALCULATOR
// =====================================================================

$('#subnetCalc').addEventListener('click', () => {
  const ipStr = $('#subnetIp').value.trim();
  const prefix = parseInt($('#subnetCidr').value, 10);

  if (!/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/.test(ipStr)) return;
  if (isNaN(prefix) || prefix < 0 || prefix > 32) return;

  const r = calcSubnet(ipStr, prefix);

  const RESULT_FIELDS = [
    { label: 'Network Address',  value: r.network },
    { label: 'Broadcast Address',value: r.broadcast },
    { label: 'Subnet Mask',      value: r.mask },
    { label: 'Wildcard Mask',    value: r.wildcard },
    { label: 'Usable Hosts',     value: r.usableHosts.toLocaleString() },
    { label: 'Total Addresses',  value: r.totalAddresses.toLocaleString() },
    { label: 'First Usable',     value: r.firstUsable },
    { label: 'Last Usable',      value: r.lastUsable },
  ];

  $('#subnetResults').innerHTML = RESULT_FIELDS.map(f => `
    <div class="result-item">
      <div class="ri-label">${f.label}</div>
      <div class="ri-value">${f.value}</div>
    </div>
  `).join('');

  const bd = $('#binaryDisplay');
  bd.style.display = 'block';
  const ipBin = r.ipBinary.join('.');
  const maskBin = r.maskBinary.join('.');
  const netBits = ipBin.replace(/\./g, '').slice(0, prefix);
  const hostBits = ipBin.replace(/\./g, '').slice(prefix);

  bd.innerHTML = `
    <div><strong style="color:var(--text-muted);width:60px;display:inline-block;">IP:</strong>
      <span class="network-bits">${netBits.match(/.{1,8}/g)?.join('<span class="separator">.</span>') || ''}</span><span class="host-bits">${hostBits.match(/.{1,8}/g)?.map((s,i) => (i===0 && netBits.length % 8 !== 0 ? '' : '<span class="separator">.</span>') + s).join('') || ''}</span>
    </div>
    <div><strong style="color:var(--text-muted);width:60px;display:inline-block;">Mask:</strong>
      <span class="octet">${maskBin}</span>
    </div>
    <div style="margin-top:0.4rem;font-size:0.7rem;color:var(--text-muted);">
      <span class="network-bits">&#9632; network (${prefix} bits)</span> &nbsp;
      <span class="host-bits">&#9632; host (${32 - prefix} bits)</span>
    </div>
  `;
});

$('#cidrGrid').innerHTML = CIDR_ENTRIES.map(e => `
  <div class="cidr-card">
    <span class="cidr-prefix">/${e.prefix}</span>
    <span class="cidr-hosts">${e.usableHosts.toLocaleString()} hosts</span>
  </div>
`).join('');

// =====================================================================
// SUBNET PRACTICE
// =====================================================================

let practiceAnswer = null;

function newPractice() {
  const ip = randomIp();
  const prefix = PRACTICE_PREFIXES[Math.floor(Math.random() * PRACTICE_PREFIXES.length)];
  practiceAnswer = calcSubnet(ip, prefix);
  $('#practiceAddress').textContent = `${ip} /${prefix}`;

  ['ansNetwork','ansBroadcast','ansMask','ansHosts','ansFirst','ansLast'].forEach(id => {
    const el = $(`#${id}`);
    el.value = '';
    el.classList.remove('correct-input', 'incorrect-input');
  });

  const fb = $('#practiceFeedback');
  fb.classList.remove('visible', 'success', 'error');
}

const PRACTICE_FIELDS = [
  { id: 'ansNetwork',   key: 'network' },
  { id: 'ansBroadcast', key: 'broadcast' },
  { id: 'ansMask',      key: 'mask' },
  { id: 'ansHosts',     key: 'usableHosts', transform: v => parseInt(v, 10) },
  { id: 'ansFirst',     key: 'firstUsable' },
  { id: 'ansLast',      key: 'lastUsable' },
];

$('#practiceCheck').addEventListener('click', () => {
  if (!practiceAnswer) return;
  let allCorrect = true;

  PRACTICE_FIELDS.forEach(({ id, key, transform }) => {
    const el = $(`#${id}`);
    const userVal = transform ? transform(el.value.trim()) : el.value.trim();
    const correctVal = practiceAnswer[key];
    const isCorrect = String(userVal) === String(correctVal);
    el.classList.remove('correct-input', 'incorrect-input');
    el.classList.add(isCorrect ? 'correct-input' : 'incorrect-input');
    if (!isCorrect) allCorrect = false;
  });

  const fb = $('#practiceFeedback');
  fb.classList.add('visible');
  fb.classList.remove('success', 'error');
  fb.classList.add(allCorrect ? 'success' : 'error');
  fb.textContent = allCorrect ? 'All correct!' : 'Some answers need fixing. Check the highlighted fields.';
});

$('#practiceShow').addEventListener('click', () => {
  if (!practiceAnswer) return;
  PRACTICE_FIELDS.forEach(({ id, key }) => {
    const el = $(`#${id}`);
    el.value = practiceAnswer[key];
    el.classList.remove('incorrect-input');
    el.classList.add('correct-input');
  });
  const fb = $('#practiceFeedback');
  fb.classList.add('visible', 'success');
  fb.classList.remove('error');
  fb.textContent = 'Answers revealed above.';
});

$('#practiceNew').addEventListener('click', newPractice);

// =====================================================================
// REFERENCE TABLE
// =====================================================================

$('#refBody').innerHTML = PROTOCOLS.map(p => `
  <tr>
    <td class="proto-name">${p.name}</td>
    <td>${p.port}</td>
    <td><span class="layer-badge" style="background:${LAYER_BY_NUM[p.layer].color}">L${p.layer} ${LAYER_BY_NUM[p.layer].name}</span></td>
    <td>${p.transport}</td>
    <td>${p.desc}</td>
  </tr>
`).join('');

// =====================================================================
// INIT
// =====================================================================

renderOsiGame();
renderProtocolQuiz();
renderBitChart();
newNumDrill();
newCidrDrill();
newHostDrill();
newWcDrill();
newAndDrill();
newPractice();
$('#subnetCalc').click();
$('#andVizCalc').click();
</script>

</body>
</html>
